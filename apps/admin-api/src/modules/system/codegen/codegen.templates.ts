import * as path from 'path';

function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function toPascalCase(str: string): string {
  return str.split(/[-_]/).map(capitalize).join('');
}

function toCamelCase(str: string): string {
  const pascal = toPascalCase(str);
  return pascal.charAt(0).toLowerCase() + pascal.slice(1);
}

export function getTemplates(name: string, cnName: string, menuId: number) {
  const pascalName = toPascalCase(name);
  const camelName = toCamelCase(name);
  const upperName = name.toUpperCase();
  const pageId = menuId + 1;
  const btnStartId = menuId + 10;

  return {
    prisma: `/// ${cnName}表\nmodel ${pascalName} {\n  id        Int      @id @default(autoincrement())\n  name      String   @db.VarChar(100)   /// 名称\n  code      String?  @db.VarChar(50)    /// 编码\n  content   String?  @db.Text           /// 内容\n  sort      Int      @default(0)        /// 排序\n  status    Status   @default(ENABLED)  /// 状态\n  remark    String?  @db.VarChar(500)   /// 备注\n\n  // 审计字段\n  createdBy Int?                        /// 创建者ID\n  createdAt DateTime @default(now())    /// 创建时间\n  updatedBy Int?                        /// 更新者ID\n  updatedAt DateTime @updatedAt         /// 更新时间\n  deleted   Boolean  @default(false)    /// 删除标记\n  deletedAt DateTime?                   /// 删除时间\n\n  @@map("${name}")\n}\n`,
    module: `import { Module } from '@nestjs/common';\nimport { ${pascalName}Controller } from './${name}.controller';\nimport { ${pascalName}Service } from './${name}.service';\n\n@Module({\n  controllers: [${pascalName}Controller],\n  providers: [${pascalName}Service],\n  exports: [${pascalName}Service],\n})\nexport class ${pascalName}Module {}\n`,
    controller: `import {\n  Controller,\n  Get,\n  Post,\n  Put,\n  Delete,\n  Body,\n  Param,\n  Query,\n  ParseIntPipe,\n} from '@nestjs/common';\nimport { ${pascalName}Service } from './${name}.service';\nimport { Create${pascalName}Dto } from './dto/create-${name}.dto';\nimport { Update${pascalName}Dto } from './dto/update-${name}.dto';\nimport { Query${pascalName}Dto } from './dto/query-${name}.dto';\nimport { RequirePermissions } from '@/common/decorators';\nimport { ClsService } from 'nestjs-cls';\n\n@Controller('${name}')\nexport class ${pascalName}Controller {\n  constructor(\n    private readonly ${camelName}Service: ${pascalName}Service,\n    private readonly cls: ClsService,\n  ) {}\n\n  /**\n   * 创建${name}\n   */\n  @Post()\n  @RequirePermissions('${name}:add')\n  create(@Body() createDto: Create${pascalName}Dto) {\n    const userId = this.cls.get('user').id;\n    return this.${camelName}Service.create(createDto, userId);\n  }\n\n  /**\n   * 分页查询列表\n   */\n  @Get()\n  @RequirePermissions('${name}:list')\n  findAll(@Query() query: Query${pascalName}Dto) {\n    return this.${camelName}Service.findAll(query);\n  }\n\n  /**\n   * 获取详情\n   */\n  @Get(':id')\n  @RequirePermissions('${name}:query')\n  findOne(@Param('id', ParseIntPipe) id: number) {\n    return this.${camelName}Service.findOne(id);\n  }\n\n  /**\n   * 更新\n   */\n  @Put(':id')\n  @RequirePermissions('${name}:edit')\n  update(\n    @Param('id', ParseIntPipe) id: number,\n    @Body() updateDto: Update${pascalName}Dto,\n  ) {\n    const userId = this.cls.get('user').id;\n    return this.${camelName}Service.update(id, updateDto, userId);\n  }\n\n  /**\n   * 删除\n   */\n  @Delete(':id')\n  @RequirePermissions('${name}:remove')\n  remove(@Param('id', ParseIntPipe) id: number) {\n    const userId = this.cls.get('user').id;\n    return this.${camelName}Service.remove(id, userId);\n  }\n}\n`,
    service: `import { Injectable, NotFoundException } from '@nestjs/common';\nimport { PrismaService } from '@/common/prisma/prisma.service';\nimport { Create${pascalName}Dto } from './dto/create-${name}.dto';\nimport { Update${pascalName}Dto } from './dto/update-${name}.dto';\nimport { Query${pascalName}Dto } from './dto/query-${name}.dto';\n\n@Injectable()\nexport class ${pascalName}Service {\n  constructor(private prisma: PrismaService) {}\n\n  /**\n   * 创建\n   */\n  async create(dto: Create${pascalName}Dto, userId: number) {\n    return this.prisma.${camelName}.create({\n      data: {\n        ...dto,\n        createdBy: userId,\n      },\n    });\n  }\n\n  /**\n   * 分页查询\n   */\n  async findAll(query: Query${pascalName}Dto) {\n    const { page = 1, pageSize = 10, name, status } = query;\n    const skip = (page - 1) * pageSize;\n\n    const where = {\n      deleted: false,\n      ...(name && { name: { contains: name } }),\n      ...(status && { status }),\n    };\n\n    const [list, total] = await Promise.all([\n      this.prisma.${camelName}.findMany({\n        where,\n        skip,\n        take: pageSize,\n        orderBy: [{ sort: 'asc' }, { createdAt: 'desc' }],\n      }),\n      this.prisma.${camelName}.count({ where }),\n    ]);\n\n    return {\n      list,\n      total,\n      page,\n      pageSize,\n    };\n  }\n\n  /**\n   * 获取详情\n   */\n  async findOne(id: number) {\n    const record = await this.prisma.${camelName}.findFirst({\n      where: { id, deleted: false },\n    });\n    if (!record) {\n      throw new NotFoundException('记录不存在');\n    }\n    return record;\n  }\n\n  /**\n   * 更新\n   */\n  async update(id: number, dto: Update${pascalName}Dto, userId: number) {\n    await this.findOne(id);\n\n    return this.prisma.${camelName}.update({\n      where: { id },\n      data: {\n        ...dto,\n        updatedBy: userId,\n      },\n    });\n  }\n\n  /**\n   * 删除（软删除）\n   */\n  async remove(id: number, userId: number) {\n    await this.findOne(id);\n\n    return this.prisma.${camelName}.update({\n      where: { id },\n      data: {\n        deleted: true,\n        deletedAt: new Date(),\n        updatedBy: userId,\n      },\n    });\n  }\n}\n`,
    dtoCreate: `import { IsString, IsOptional, IsInt, IsEnum, MaxLength, MinLength } from 'class-validator';\nimport { Status } from '@prisma/client';\n\nexport class Create${pascalName}Dto {\n  @IsString()\n  @MinLength(1)\n  @MaxLength(100)\n  name: string;\n\n  @IsOptional()\n  @IsString()\n  @MaxLength(50)\n  code?: string;\n\n  @IsOptional()\n  @IsString()\n  content?: string;\n\n  @IsOptional()\n  @IsInt()\n  sort?: number;\n\n  @IsOptional()\n  @IsEnum(Status)\n  status?: Status;\n\n  @IsOptional()\n  @IsString()\n  @MaxLength(500)\n  remark?: string;\n}\n`,
    dtoUpdate: `import { PartialType } from 'nestjs-mapped-types';\nimport { Create${pascalName}Dto } from './create-${name}.dto';\n\nexport class Update${pascalName}Dto extends PartialType(Create${pascalName}Dto) {}\n`,
    dtoQuery: `import { IsOptional, IsString, IsEnum } from 'class-validator';\nimport { Status } from '@prisma/client';\nimport { PaginationDto } from '@/common/dto';\n\nexport class Query${pascalName}Dto extends PaginationDto {\n  @IsOptional()\n  @IsString()\n  name?: string;\n\n  @IsOptional()\n  @IsEnum(Status)\n  status?: Status;\n}\n`,
    frontendService: `import request from '@/utils/request';\n\nexport interface ${pascalName} {\n  id: number;\n  name: string;\n  code?: string;\n  content?: string;\n  sort: number;\n  status: string;\n  remark?: string;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface ${pascalName}Query {\n  page?: number;\n  pageSize?: number;\n  name?: string;\n  status?: string;\n}\n\nexport interface ${pascalName}Form {\n  name: string;\n  code?: string;\n  content?: string;\n  sort?: number;\n  status?: string;\n  remark?: string;\n}\n\nexport const ${camelName}Api = {\n  /** 获取${cnName}列表 */\n  list(params?: ${pascalName}Query) {\n    return request.get<{ list: ${pascalName}[]; total: number }>('/${name}', { params });\n  },\n\n  /** 获取${cnName}详情 */\n  get(id: number) {\n    return request.get<${pascalName}>(\`/${name}/\${id}\`);\n  },\n\n  /** 创建${cnName} */\n  create(data: ${pascalName}Form) {\n    return request.post<${pascalName}>('/${name}', data);\n  },\n\n  /** 更新${cnName} */\n  update(id: number, data: Partial<${pascalName}Form>) {\n    return request.put<${pascalName}>(\`/${name}/\${id}\`, data);\n  },\n\n  /** 删除${cnName} */\n  delete(id: number) {\n    return request.delete(\`/${name}/\${id}\`);\n  },\n};\n`,
    frontendPage: `import { useRef, useState } from 'react';\nimport { message, Modal, Space } from 'antd';\nimport { PlusOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons';\nimport {\n  ProTable,\n  ProColumns,\n  ActionType,\n  ModalForm,\n  ProFormText,\n  ProFormTextArea,\n  ProFormDigit,\n  ProFormSelect,\n} from '@ant-design/pro-components';\nimport { useMutation } from '@tanstack/react-query';\nimport { ${camelName}Api, ${pascalName}, ${pascalName}Form } from '@/services/${name}';\nimport { PermissionButton } from '@/components/PermissionButton';\nimport { ${upperName} } from '@/constants/permissions';\n\nexport default function ${pascalName}Page() {\n  const actionRef = useRef<ActionType>();\n  const [modalOpen, setModalOpen] = useState(false);\n  const [editingRecord, setEditingRecord] = useState<${pascalName} | null>(null);\n\n  // 创建/更新\n  const saveMutation = useMutation({\n    mutationFn: (data: ${pascalName}Form) => {\n      if (editingRecord) {\n        return ${camelName}Api.update(editingRecord.id, data);\n      }\n      return ${camelName}Api.create(data);\n    },\n    onSuccess: () => {\n      message.success(editingRecord ? '更新成功' : '创建成功');\n      setModalOpen(false);\n      setEditingRecord(null);\n      actionRef.current?.reload();\n    },\n    onError: (error: any) => {\n      message.error(error?.message || '操作失败');\n    },\n  });\n\n  // 删除\n  const deleteMutation = useMutation({\n    mutationFn: ${camelName}Api.delete,\n    onSuccess: () => {\n      message.success('删除成功');\n      actionRef.current?.reload();\n    },\n    onError: (error: any) => {\n      message.error(error?.message || '删除失败');\n    },\n  });\n\n  const handleDelete = (id: number) => {\n    Modal.confirm({\n      title: '确认删除',\n      content: '确定要删除这条记录吗？删除后无法恢复。',\n      okType: 'danger',\n      onOk: () => deleteMutation.mutate(id),\n    });\n  };\n\n  const handleEdit = (record: ${pascalName}) => {\n    setEditingRecord(record);\n    setModalOpen(true);\n  };\n\n  const handleAdd = () => {\n    setEditingRecord(null);\n    setModalOpen(true);\n  };\n\n  const columns: ProColumns<${pascalName}>[] = [\n    {\n      title: '名称',\n      dataIndex: 'name',\n      width: 150,\n    },\n    {\n      title: '编码',\n      dataIndex: 'code',\n      width: 120,\n      search: false,\n    },\n    {\n      title: '排序',\n      dataIndex: 'sort',\n      width: 80,\n      search: false,\n    },\n    {\n      title: '状态',\n      dataIndex: 'status',\n      width: 100,\n      valueEnum: {\n        ENABLED: { text: '启用', status: 'Success' },\n        DISABLED: { text: '禁用', status: 'Error' },\n      },\n    },\n    {\n      title: '备注',\n      dataIndex: 'remark',\n      width: 200,\n      ellipsis: true,\n      search: false,\n    },\n    {\n      title: '创建时间',\n      dataIndex: 'createdAt',\n      width: 180,\n      valueType: 'dateTime',\n      search: false,\n    },\n    {\n      title: '操作',\n      valueType: 'option',\n      width: 150,\n      fixed: 'right',\n      render: (_, record) => (\n        <Space>\n          <PermissionButton\n            permission={${upperName}.EDIT}\n            type="link"\n            size="small"\n            icon={<EditOutlined />}\n            onClick={() => handleEdit(record)}\n          >\n            编辑\n          </PermissionButton>\n          <PermissionButton\n            permission={${upperName}.REMOVE}\n            type="link"\n            size="small"\n            danger\n            icon={<DeleteOutlined />}\n            onClick={() => handleDelete(record.id)}\n          >\n            删除\n          </PermissionButton>\n        </Space>\n      ),\n    },\n  ];\n\n  return (\n    <>\n      <ProTable<${pascalName}>\n        headerTitle="${cnName}列表"\n        actionRef={actionRef}\n        columns={columns}\n        rowKey="id"\n        scroll={{ x: 1000 }}\n        request={async (params) => {\n          const { current, pageSize, ...rest } = params;\n          try {\n            const res = await ${camelName}Api.list({\n              page: current,\n              pageSize,\n              ...rest,\n            });\n            return {\n              data: res.list,\n              total: res.total,\n              success: true,\n            };\n          } catch (error) {\n            return { data: [], total: 0, success: false };\n          }\n        }}\n        toolBarRender={() => [\n          <PermissionButton\n            key="add"\n            permission={${upperName}.ADD}\n            type="primary"\n            icon={<PlusOutlined />}\n            onClick={handleAdd}\n          >\n            新增\n          </PermissionButton>,\n        ]}\n        pagination={{\n          defaultPageSize: 10,\n          showSizeChanger: true,\n          showQuickJumper: true,\n        }}\n      />\n\n      <ModalForm<${pascalName}Form>\n        title={editingRecord ? '编辑${cnName}' : '新增${cnName}'}\n        open={modalOpen}\n        onOpenChange={setModalOpen}\n        initialValues={editingRecord || { sort: 0, status: 'ENABLED' }}\n        onFinish={async (values) => {\n          await saveMutation.mutateAsync(values);\n          return true;\n        }}\n        modalProps={{\n          destroyOnClose: true,\n          maskClosable: false,\n        }}\n      >\n        <ProFormText\n          name="name"\n          label="名称"\n          placeholder="请输入名称"\n          rules={[{ required: true, message: '请输入名称' }]}\n        />\n        <ProFormText\n          name="code"\n          label="编码"\n          placeholder="请输入编码"\n        />\n        <ProFormDigit\n          name="sort"\n          label="排序"\n          placeholder="请输入排序号"\n          min={0}\n          fieldProps={{ precision: 0 }}\n        />\n        <ProFormSelect\n          name="status"\n          label="状态"\n          options={[\n            { label: '启用', value: 'ENABLED' },\n            { label: '禁用', value: 'DISABLED' },\n          ]}\n        />\n        <ProFormTextArea\n          name="content"\n          label="内容"\n          placeholder="请输入内容"\n        />\n        <ProFormTextArea\n          name="remark"\n          label="备注"\n          placeholder="请输入备注"\n        />\n      </ModalForm>\n    </>\n  );\n}\n`,
    permissions: `// ${name} 权限 - 请添加到 src/constants/permissions.ts\nexport const ${upperName} = {\n  LIST: '${name}:list',\n  ADD: '${name}:add',\n  EDIT: '${name}:edit',\n  REMOVE: '${name}:remove',\n  QUERY: '${name}:query',\n  EXPORT: '${name}:export',\n};\n`,
    seedMenu: `// ============================================================\n// ${cnName}模块菜单配置 - 请添加到 prisma/seed.ts 的 menus 数组中\n// ============================================================\n\n// 目录菜单\n{\n  id: ${menuId},\n  parentId: 0,\n  name: '${cnName}',\n  path: '/${name}',\n  type: MenuType.DIR,\n  icon: 'AppstoreOutlined',\n  sort: 10,\n  perms: '${name}:manage'\n},\n\n// 页面菜单\n{\n  id: ${pageId},\n  parentId: ${menuId},\n  name: '${cnName}列表',\n  path: '/${name}/list',\n  component: '${name}/index',\n  type: MenuType.MENU,\n  icon: 'UnorderedListOutlined',\n  sort: 1,\n  perms: '${name}:list'\n},\n\n// 按钮权限\n{ id: ${btnStartId}, parentId: ${pageId}, name: '${cnName}查询', path: null, type: MenuType.BUTTON, icon: null, sort: 1, perms: '${name}:query' },\n{ id: ${btnStartId + 1}, parentId: ${pageId}, name: '${cnName}新增', path: null, type: MenuType.BUTTON, icon: null, sort: 2, perms: '${name}:add' },\n{ id: ${btnStartId + 2}, parentId: ${pageId}, name: '${cnName}修改', path: null, type: MenuType.BUTTON, icon: null, sort: 3, perms: '${name}:edit' },\n{ id: ${btnStartId + 3}, parentId: ${pageId}, name: '${cnName}删除', path: null, type: MenuType.BUTTON, icon: null, sort: 4, perms: '${name}:remove' },\n{ id: ${btnStartId + 4}, parentId: ${pageId}, name: '${cnName}导出', path: null, type: MenuType.BUTTON, icon: null, sort: 5, perms: '${name}:export' },\n`,
    route: `// ============================================================\n// ${cnName}路由配置 - 请添加到 src/App.tsx\n// ============================================================\n\n// 1. 添加懒加载导入\nconst ${pascalName}List = lazy(() => import('./pages/${name}'));\n\n// 2. 添加路由配置 (在 <Routes> 中添加)\n<Route\n  path="${name}/list"\n  element={\n    <AuthRoute requiredPermission={${upperName}.LIST}>\n      <${pascalName}List />\n    </AuthRoute>\n  }\n/>\n\n// 3. 添加权限常量导入\nimport { ${upperName} } from './constants/permissions';\n`,
    paths: {
      prisma: path.join('apps/admin-api', 'prisma', `${name}.prisma`),
      moduleDir: path.join('apps/admin-api', 'src/modules', name),
      module: path.join('apps/admin-api', 'src/modules', name, `${name}.module.ts`),
      controller: path.join('apps/admin-api', 'src/modules', name, `${name}.controller.ts`),
      service: path.join('apps/admin-api', 'src/modules', name, `${name}.service.ts`),
      dtoCreate: path.join('apps/admin-api', 'src/modules', name, 'dto', `create-${name}.dto.ts`),
      dtoUpdate: path.join('apps/admin-api', 'src/modules', name, 'dto', `update-${name}.dto.ts`),
      dtoQuery: path.join('apps/admin-api', 'src/modules', name, 'dto', `query-${name}.dto.ts`),
      page: path.join('apps/admin-web', 'src/pages', name, 'index.tsx'),
      frontendService: path.join('apps/admin-web', 'src/services', `${name}.ts`),
      configPermissions: path.join('scripts', 'generated', name, 'permissions.ts'),
      configSeedMenu: path.join('scripts', 'generated', name, 'seed-menu.ts'),
      configRoute: path.join('scripts', 'generated', name, 'route.tsx'),
    },
  };
}