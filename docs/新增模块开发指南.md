# 新增模块开发指南

本文档详细说明在 nest-react-admin 项目中新增一个业务模块所需的全部代码和步骤。

## 目录

- [快速开始（代码生成器）](#快速开始代码生成器)
- [概述](#概述)
- [后端代码](#后端代码)
- [前端代码](#前端代码)
- [种子文件更新](#种子文件更新)
- [完整示例](#完整示例)

---

## 快速开始（代码生成器）

推荐使用代码生成器一键生成模块代码，省去手动创建文件的繁琐步骤。

### 基本用法

```bash
# 生成模块（默认中文名为"模块名+管理"）
pnpm gen:module article

# 指定中文名
pnpm gen:module product --cn 商品

# 指定菜单起始ID（避免与现有模块冲突）
pnpm gen:module order --id 300

# 查看帮助
pnpm gen:module --help
```

### 生成器会自动创建

| 类型 | 文件 |
|------|------|
| 后端 Prisma 模型 | `prisma/<module>.prisma` |
| 后端 Module | `src/modules/<module>/<module>.module.ts` |
| 后端 Controller | `src/modules/<module>/<module>.controller.ts` |
| 后端 Service | `src/modules/<module>/<module>.service.ts` |
| 后端 DTOs | `src/modules/<module>/dto/*.dto.ts` |
| 前端页面 | `src/pages/<module>/index.tsx` |
| 前端 API 服务 | `src/services/<module>.ts` |
| 配置参考文件 | `scripts/generated/<module>/*.ts` |

### 生成后需要手动完成

1. **生成 Prisma Client 和迁移数据库**
   ```bash
   pnpm db:generate && pnpm db:migrate
   ```

2. **注册后端模块**
   编辑 `apps/admin-api/src/app.module.ts`：
   ```typescript
   import { ArticleModule } from './modules/article/article.module';

   @Module({
     imports: [
       // ...
       ArticleModule,
     ],
   })
   ```

3. **添加权限常量**
   编辑 `apps/admin-web/src/constants/permissions.ts`，参考 `scripts/generated/<module>/permissions.ts`

4. **添加前端路由**
   编辑 `apps/admin-web/src/App.tsx`，参考 `scripts/generated/<module>/route.tsx`

5. **更新种子文件**
   编辑 `apps/admin-api/prisma/seed.ts`，参考 `scripts/generated/<module>/seed-menu.ts`

6. **运行种子文件**
   ```bash
   pnpm db:seed
   ```

### 示例：生成文章管理模块

```bash
# 1. 生成代码
pnpm gen:module article --cn 文章

# 2. 数据库迁移
pnpm db:generate && pnpm db:migrate

# 3. 按提示完成手动配置...

# 4. 运行种子
pnpm db:seed

# 5. 启动开发服务器
pnpm dev
```

---

## 概述

新增一个完整的业务模块需要以下文件：

### 后端文件 (apps/admin-api)

| 序号 | 文件路径 | 说明 |
|------|----------|------|
| 1 | `prisma/example.prisma` | 数据库模型定义 |
| 2 | `src/modules/example/example.module.ts` | 模块定义 |
| 3 | `src/modules/example/example.controller.ts` | 控制器（API 路由） |
| 4 | `src/modules/example/example.service.ts` | 业务逻辑服务 |
| 5 | `src/modules/example/dto/create-example.dto.ts` | 创建参数验证 |
| 6 | `src/modules/example/dto/update-example.dto.ts` | 更新参数验证 |
| 7 | `src/modules/example/dto/query-example.dto.ts` | 查询参数验证 |

### 前端文件 (apps/admin-web)

| 序号 | 文件路径 | 说明 |
|------|----------|------|
| 1 | `src/pages/example/index.tsx` | 列表页面 |
| 2 | `src/services/example.ts` | API 接口服务 |
| 3 | `src/constants/permissions.ts` | 权限常量（追加） |

### 种子文件 (apps/admin-api)

| 序号 | 文件路径 | 说明 |
|------|----------|------|
| 1 | `prisma/seed.ts` | 追加菜单和按钮权限配置 |

### 数据库菜单配置

需要在 `SysMenu` 表中添加菜单和按钮权限记录（通过种子文件或后台菜单管理）。

---

## 后端代码

### 1. 数据库模型 (prisma/example.prisma)

```prisma
/// 示例表
model Example {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)   /// 名称
  code      String   @unique @db.VarChar(50)   /// 编码（唯一）
  content   String?  @db.Text   /// 内容
  sort      Int      @default(0)   /// 排序
  status    Status   @default(ENABLED)   /// 状态
  remark    String?  @db.VarChar(500)   /// 备注

  // 审计字段
  createdBy String?   @map("created_by") @db.VarChar(64) /// 创建者ID
  createdAt DateTime @default(now()) @map("created_at")   /// 创建时间
  updatedBy String?   @map("updated_by") @db.VarChar(64) /// 更新者ID
  updatedAt DateTime @updatedAt @map("updated_at")   /// 更新时间
  deleted   Boolean  @default(false) @map("deleted")   /// 删除标记
  deletedAt DateTime? @map("deleted_at")   /// 删除时间

  @@map("sys_example")   // 数据库表名
}
```

> **注意**: 创建后需要执行 `pnpm db:generate` 生成 Prisma Client，然后执行 `pnpm db:migrate` 创建数据库表。

#### 审计字段规范

所有业务表必须包含以下审计字段，统一使用 **String** 类型存储用户ID：

```prisma
// 审计字段
createdBy String?   @map("created_by") @db.VarChar(64) /// 创建者ID
createdAt DateTime @default(now()) @map("created_at")   /// 创建时间
updatedBy String?   @map("updated_by") @db.VarChar(64) /// 更新者ID
updatedAt DateTime @updatedAt @map("updated_at")   /// 更新时间
deleted   Boolean  @default(false) @map("deleted")   /// 删除标记
deletedAt DateTime? @map("deleted_at")   /// 删除时间
```

**规范说明**：
- `createdBy` 和 `updatedBy` 统一使用 `String` 类型，存储用户ID
- 所有字段必须使用 `@map()` 指定数据库字段名（蛇形命名法）
- 在创建和更新记录时，需要在服务层自动设置这些字段的值
- 采用软删除机制，不物理删除数据，只标记 `deleted = true`

### 2. 模块定义 (src/modules/example/example.module.ts)

```typescript
import { Module } from '@nestjs/common';
import { ExampleController } from './example.controller';
import { ExampleService } from './example.service';

@Module({
  controllers: [ExampleController],
  providers: [ExampleService],
  exports: [ExampleService],
})
export class ExampleModule {}
```

### 3. 控制器 (src/modules/example/example.controller.ts)

```typescript
import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  ParseIntPipe,
} from '@nestjs/common';
import { ExampleService } from './example.service';
import { CreateExampleDto } from './dto/create-example.dto';
import { UpdateExampleDto } from './dto/update-example.dto';
import { QueryExampleDto } from './dto/query-example.dto';
import { RequirePermissions } from '@/common/decorators';
import { CurrentUser } from '@/common/decorators';

@Controller('example')
export class ExampleController {
  constructor(private readonly exampleService: ExampleService) {}

  /**
   * 创建
   */
  @Post()
  @RequirePermissions('example:add')
  create(
    @Body() createDto: CreateExampleDto,
    @CurrentUser('sub') userId: string,
  ) {
    return this.exampleService.create(createDto, userId);
  }

  /**
   * 分页查询列表
   */
  @Get()
  @RequirePermissions('example:list')
  findAll(@Query() query: QueryExampleDto) {
    return this.exampleService.findAll(query);
  }

  /**
   * 获取详情
   */
  @Get(':id')
  @RequirePermissions('example:query')
  findOne(@Param('id', ParseIntPipe) id: number) {
    return this.exampleService.findOne(id);
  }

  /**
   * 更新
   */
  @Put(':id')
  @RequirePermissions('example:edit')
  update(
    @Param('id', ParseIntPipe) id: number,
    @Body() updateDto: UpdateExampleDto,
    @CurrentUser('sub') userId: string,
  ) {
    return this.exampleService.update(id, updateDto, userId);
  }

  /**
   * 删除
   */
  @Delete(':id')
  @RequirePermissions('example:remove')
  remove(
    @Param('id', ParseIntPipe) id: number,
    @CurrentUser('sub') userId: string,
  ) {
    return this.exampleService.remove(id, userId);
  }
}
```

### 4. 服务层 (src/modules/example/example.service.ts)

```typescript
import { Injectable, NotFoundException, ConflictException } from '@nestjs/common';
import { PrismaService } from '@/common/prisma/prisma.service';
import { CreateExampleDto } from './dto/create-example.dto';
import { UpdateExampleDto } from './dto/update-example.dto';
import { QueryExampleDto } from './dto/query-example.dto';

@Injectable()
export class ExampleService {
  constructor(private prisma: PrismaService) {}

  /**
   * 创建
   */
  async create(dto: CreateExampleDto, userId: string) {
    // 检查编码是否已存在
    const existing = await this.prisma.example.findFirst({
      where: { code: dto.code, deleted: false },
    });
    if (existing) {
      throw new ConflictException('编码已存在');
    }

    return this.prisma.example.create({
      data: {
        ...dto,
        createdBy: userId,
      },
    });
  }

  /**
   * 分页查询
   */
  async findAll(query: QueryExampleDto) {
    const { page = 1, pageSize = 10, name, code, status } = query;
    const skip = (page - 1) * pageSize;

    const where = {
      deleted: false,
      ...(name && { name: { contains: name } }),
      ...(code && { code: { contains: code } }),
      ...(status && { status }),
    };

    const [list, total] = await Promise.all([
      this.prisma.example.findMany({
        where,
        skip,
        take: pageSize,
        orderBy: [{ sort: 'asc' }, { createdAt: 'desc' }],
      }),
      this.prisma.example.count({ where }),
    ]);

    return {
      list,
      total,
      page,
      pageSize,
    };
  }

  /**
   * 获取详情
   */
  async findOne(id: number) {
    const record = await this.prisma.example.findFirst({
      where: { id, deleted: false },
    });
    if (!record) {
      throw new NotFoundException('记录不存在');
    }
    return record;
  }

  /**
   * 更新
   */
  async update(id: number, dto: UpdateExampleDto, userId: string) {
    await this.findOne(id); // 确保记录存在

    // 如果更新编码，检查是否与其他记录冲突
    if (dto.code) {
      const existing = await this.prisma.example.findFirst({
        where: {
          code: dto.code,
          deleted: false,
          NOT: { id },
        },
      });
      if (existing) {
        throw new ConflictException('编码已存在');
      }
    }

    return this.prisma.example.update({
      where: { id },
      data: {
        ...dto,
        updatedBy: userId,
      },
    });
  }

  /**
   * 删除（软删除）
   */
  async remove(id: number, userId: string) {
    await this.findOne(id); // 确保记录存在

    return this.prisma.example.update({
      where: { id },
      data: {
        deleted: true,
        deletedAt: new Date(),
        updatedBy: userId,
      },
    });
  }
}
```

### 5. 创建 DTO (src/modules/example/dto/create-example.dto.ts)

```typescript
import { IsString, IsOptional, IsInt, IsEnum, MaxLength, MinLength } from 'class-validator';
import { Status } from '@prisma/client';

export class CreateExampleDto {
  @IsString()
  @MinLength(1)
  @MaxLength(100)
  name: string;

  @IsString()
  @MinLength(1)
  @MaxLength(50)
  code: string;

  @IsOptional()
  @IsString()
  content?: string;

  @IsOptional()
  @IsInt()
  sort?: number;

  @IsOptional()
  @IsEnum(Status)
  status?: Status;

  @IsOptional()
  @IsString()
  @MaxLength(500)
  remark?: string;
}
```

### 6. 更新 DTO (src/modules/example/dto/update-example.dto.ts)

```typescript
import { PartialType } from '@nestjs/mapped-types';
import { CreateExampleDto } from './create-example.dto';

export class UpdateExampleDto extends PartialType(CreateExampleDto) {}
```

### 7. 查询 DTO (src/modules/example/dto/query-example.dto.ts)

```typescript
import { IsOptional, IsString, IsEnum } from 'class-validator';
import { Status } from '@prisma/client';
import { PaginationDto } from '@/common/dto';

export class QueryExampleDto extends PaginationDto {
  @IsOptional()
  @IsString()
  name?: string;

  @IsOptional()
  @IsString()
  code?: string;

  @IsOptional()
  @IsEnum(Status)
  status?: Status;
}
```

### 8. 注册模块

在 `src/modules/system/system.module.ts` 或 `src/app.module.ts` 中导入新模块：

```typescript
import { ExampleModule } from './example/example.module';

@Module({
  imports: [
    // ... 其他模块
    ExampleModule,
  ],
})
export class SystemModule {}
```

---

## 前端代码

### 1. 权限常量 (src/constants/permissions.ts)

在文件中追加：

```typescript
export const EXAMPLE = {
  LIST: 'example:list',
  ADD: 'example:add',
  EDIT: 'example:edit',
  REMOVE: 'example:remove',
  QUERY: 'example:query',
  EXPORT: 'example:export',
};
```

### 2. API 服务 (src/services/example.ts)

```typescript
import request from '@/utils/request';

export interface Example {
  id: number;
  name: string;
  code: string;
  content?: string;
  sort: number;
  status: string;
  remark?: string;
  createdAt: string;
  updatedAt: string;
}

export interface ExampleQuery {
  page?: number;
  pageSize?: number;
  name?: string;
  code?: string;
  status?: string;
}

export interface ExampleForm {
  name: string;
  code: string;
  content?: string;
  sort?: number;
  status?: string;
  remark?: string;
}

export const exampleApi = {
  /** 获取列表 */
  list(params?: ExampleQuery) {
    return request.get<{ list: Example[]; total: number }>('/example', { params });
  },

  /** 获取详情 */
  get(id: number) {
    return request.get<Example>(`/example/${id}`);
  },

  /** 创建 */
  create(data: ExampleForm) {
    return request.post<Example>('/example', data);
  },

  /** 更新 */
  update(id: number, data: Partial<ExampleForm>) {
    return request.put<Example>(`/example/${id}`, data);
  },

  /** 删除 */
  delete(id: number) {
    return request.delete(`/example/${id}`);
  },
};
```

### 3. 列表页面 (src/pages/example/index.tsx)

```tsx
import { useRef, useState } from 'react';
import { Button, message, Modal, Space, Tag, Form, Input, Select } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons';
import { ProTable, ProColumns, ActionType, ModalForm, ProFormText, ProFormTextArea, ProFormDigit, ProFormSelect } from '@ant-design/pro-components';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { exampleApi, Example, ExampleForm } from '@/services/example';
import { PermissionButton } from '@/components/PermissionButton';
import { EXAMPLE } from '@/constants/permissions';

export default function ExamplePage() {
  const actionRef = useRef<ActionType>();
  const queryClient = useQueryClient();
  const [modalOpen, setModalOpen] = useState(false);
  const [editingRecord, setEditingRecord] = useState<Example | null>(null);

  // 创建/更新
  const saveMutation = useMutation({
    mutationFn: (data: ExampleForm) => {
      if (editingRecord) {
        return exampleApi.update(editingRecord.id, data);
      }
      return exampleApi.create(data);
    },
    onSuccess: () => {
      message.success(editingRecord ? '更新成功' : '创建成功');
      setModalOpen(false);
      setEditingRecord(null);
      actionRef.current?.reload();
    },
  });

  // 删除
  const deleteMutation = useMutation({
    mutationFn: exampleApi.delete,
    onSuccess: () => {
      message.success('删除成功');
      actionRef.current?.reload();
    },
  });

  const handleDelete = (id: number) => {
    Modal.confirm({
      title: '确认删除',
      content: '确定要删除这条记录吗？',
      onOk: () => deleteMutation.mutate(id),
    });
  };

  const handleEdit = (record: Example) => {
    setEditingRecord(record);
    setModalOpen(true);
  };

  const columns: ProColumns<Example>[] = [
    {
      title: '名称',
      dataIndex: 'name',
      width: 150,
    },
    {
      title: '编码',
      dataIndex: 'code',
      width: 120,
    },
    {
      title: '排序',
      dataIndex: 'sort',
      width: 80,
      search: false,
    },
    {
      title: '状态',
      dataIndex: 'status',
      width: 100,
      valueEnum: {
        ENABLED: { text: '启用', status: 'Success' },
        DISABLED: { text: '禁用', status: 'Error' },
      },
    },
    {
      title: '备注',
      dataIndex: 'remark',
      width: 200,
      ellipsis: true,
      search: false,
    },
    {
      title: '创建时间',
      dataIndex: 'createdAt',
      width: 180,
      valueType: 'dateTime',
      search: false,
    },
    {
      title: '操作',
      valueType: 'option',
      width: 150,
      render: (_, record) => (
        <Space>
          <PermissionButton
            permission={EXAMPLE.EDIT}
            type="link"
            size="small"
            icon={<EditOutlined />}
            onClick={() => handleEdit(record)}
          >
            编辑
          </PermissionButton>
          <PermissionButton
            permission={EXAMPLE.REMOVE}
            type="link"
            size="small"
            danger
            icon={<DeleteOutlined />}
            onClick={() => handleDelete(record.id)}
          >
            删除
          </PermissionButton>
        </Space>
      ),
    },
  ];

  return (
    <>
      <ProTable<Example>
        actionRef={actionRef}
        columns={columns}
        rowKey="id"
        request={async (params) => {
          const { current, pageSize, ...rest } = params;
          const res = await exampleApi.list({
            page: current,
            pageSize,
            ...rest,
          });
          return {
            data: res.list,
            total: res.total,
            success: true,
          };
        }}
        toolBarRender={() => [
          <PermissionButton
            key="add"
            permission={EXAMPLE.ADD}
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setEditingRecord(null);
              setModalOpen(true);
            }}
          >
            新增
          </PermissionButton>,
        ]}
      />

      <ModalForm<ExampleForm>
        title={editingRecord ? '编辑' : '新增'}
        open={modalOpen}
        onOpenChange={setModalOpen}
        initialValues={editingRecord || { sort: 0, status: 'ENABLED' }}
        onFinish={async (values) => {
          await saveMutation.mutateAsync(values);
          return true;
        }}
        modalProps={{ destroyOnClose: true }}
      >
        <ProFormText
          name="name"
          label="名称"
          rules={[{ required: true, message: '请输入名称' }]}
        />
        <ProFormText
          name="code"
          label="编码"
          rules={[{ required: true, message: '请输入编码' }]}
          disabled={!!editingRecord}
        />
        <ProFormDigit
          name="sort"
          label="排序"
          min={0}
        />
        <ProFormSelect
          name="status"
          label="状态"
          options={[
            { label: '启用', value: 'ENABLED' },
            { label: '禁用', value: 'DISABLED' },
          ]}
        />
        <ProFormTextArea
          name="content"
          label="内容"
        />
        <ProFormTextArea
          name="remark"
          label="备注"
        />
      </ModalForm>
    </>
  );
}
```

---

## 数据库菜单配置

需要在 `SysMenu` 表中插入菜单和按钮权限记录：

```sql
-- 目录菜单
INSERT INTO sys_menu (name, parent_id, path, component, type, icon, sort, visible, status, perms)
VALUES ('示例管理', 0, '/example', NULL, 'DIR', 'AppstoreOutlined', 10, true, 'ENABLED', NULL);

-- 页面菜单（假设父级 ID 为上一条插入的 ID）
INSERT INTO sys_menu (name, parent_id, path, component, type, icon, sort, visible, status, perms)
VALUES ('示例列表', @parent_id, 'list', 'example/index', 'MENU', NULL, 1, true, 'ENABLED', 'example:list');

-- 按钮权限
INSERT INTO sys_menu (name, parent_id, type, perms, sort) VALUES
('新增', @menu_id, 'BUTTON', 'example:add', 1),
('编辑', @menu_id, 'BUTTON', 'example:edit', 2),
('删除', @menu_id, 'BUTTON', 'example:remove', 3),
('查询', @menu_id, 'BUTTON', 'example:query', 4);
```

---

## 种子文件更新

新增模块时，需要更新种子文件 `apps/admin-api/prisma/seed.ts`，添加新模块的菜单和按钮权限配置。

### 为什么需要更新种子文件

| 场景 | 是否需要更新 | 说明 |
|------|-------------|------|
| **全新部署** | ✅ 必须 | 种子文件用于初始化菜单和权限，新模块必须添加 |
| **已有数据库** | ⚠️ 可选 | 可以通过后台「菜单管理」页面手动添加菜单 |

### 菜单 ID 规划建议

为避免 ID 冲突，建议按以下规则分配菜单 ID：

| ID 范围 | 用途 |
|---------|------|
| 1-9 | 首页、仪表盘 |
| 10-99 | 系统管理目录和页面 |
| 100-199 | 系统管理按钮权限 |
| 200-299 | 业务模块 A（目录 200，页面 201-209，按钮 210-219） |
| 300-399 | 业务模块 B |
| 400-499 | 业务模块 C |
| ... | 以此类推 |

### 现有菜单 ID 分配参考

| ID | 菜单名称 | 类型 | 路径 |
|----|----------|------|------|
| 1 | 首页 | MENU | /dashboard |
| 10 | 系统管理 | DIR | /system |
| 11 | 用户管理 | MENU | /system/user |
| 12 | 角色管理 | MENU | /system/role |
| 13 | 菜单管理 | MENU | /system/menu |
| 14 | 部门管理 | MENU | /system/dept |
| 15 | (预留) 岗位管理 | - | - |
| 16 | 字典管理 | MENU | /system/dict |
| 17 | 参数设置 | MENU | /system/config |
| 18 | 通知公告 | MENU | /system/notice |
| 19 | 日志管理 | DIR | /system/log |
| 20 | 操作日志 | MENU | /system/operlog |
| 21 | 登录日志 | MENU | /system/loginlog |
| 100-104 | 用户管理按钮 | BUTTON | - |
| 110-113 | 角色管理按钮 | BUTTON | - |
| 120-123 | 菜单管理按钮 | BUTTON | - |
| 130-133 | 部门管理按钮 | BUTTON | - |
| 140-143 | 字典管理按钮 | BUTTON | - |
| 150-153 | (预留) 岗位管理按钮 | BUTTON | - |
| 160-163 | 参数设置按钮 | BUTTON | - |
| 170-173 | 通知公告按钮 | BUTTON | - |
| 180-181 | 操作日志按钮 | BUTTON | - |
| 185-186 | 登录日志按钮 | BUTTON | - |

> **注意**: ID 15 和 150-153 为岗位管理预留，目前未实现。新增业务模块请从 ID 200 开始。

### 更新示例

在 `seed.ts` 文件的 `menus` 数组中追加新模块的菜单配置：

```typescript
const menus = [
  // ... 现有菜单配置（ID 1-199）

  // ============================================================
  // 新增：示例管理模块（ID 200-219）
  // ============================================================

  // 目录菜单
  {
    id: 200,
    parentId: 0,
    name: '示例管理',
    path: '/example',
    type: MenuType.DIR,
    icon: 'AppstoreOutlined',
    sort: 10,
    perms: 'example:manage'
  },

  // 页面菜单
  {
    id: 201,
    parentId: 200,
    name: '示例列表',
    path: '/example/list',
    component: 'example/index',
    type: MenuType.MENU,
    icon: 'UnorderedListOutlined',
    sort: 1,
    perms: 'example:list'
  },

  // 按钮权限
  { id: 210, parentId: 201, name: '示例查询', path: null, type: MenuType.BUTTON, icon: null, sort: 1, perms: 'example:query' },
  { id: 211, parentId: 201, name: '示例新增', path: null, type: MenuType.BUTTON, icon: null, sort: 2, perms: 'example:add' },
  { id: 212, parentId: 201, name: '示例修改', path: null, type: MenuType.BUTTON, icon: null, sort: 3, perms: 'example:edit' },
  { id: 213, parentId: 201, name: '示例删除', path: null, type: MenuType.BUTTON, icon: null, sort: 4, perms: 'example:remove' },
  { id: 214, parentId: 201, name: '示例导出', path: null, type: MenuType.BUTTON, icon: null, sort: 5, perms: 'example:export' },
];
```

### 菜单字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | number | 菜单ID，全局唯一 |
| `parentId` | number | 父级ID，0 表示顶级菜单 |
| `name` | string | 菜单名称 |
| `path` | string | 路由路径 |
| `component` | string | 组件路径（相对于 pages 目录） |
| `type` | MenuType | 菜单类型：`DIR`(目录)、`MENU`(菜单)、`BUTTON`(按钮) |
| `icon` | string | 图标名称（Ant Design 图标） |
| `sort` | number | 排序号（越小越靠前） |
| `perms` | string | 权限标识 |

### 常用图标参考

| 图标名称 | 适用场景 |
|----------|----------|
| `DashboardOutlined` | 仪表盘 |
| `SettingOutlined` | 设置/系统管理 |
| `UserOutlined` | 用户管理 |
| `TeamOutlined` | 角色/团队 |
| `MenuOutlined` | 菜单管理 |
| `ApartmentOutlined` | 部门/组织 |
| `BookOutlined` | 字典/文档 |
| `FileTextOutlined` | 日志/文件 |
| `AppstoreOutlined` | 应用/模块 |
| `ShoppingOutlined` | 商品/购物 |
| `OrderedListOutlined` | 订单/列表 |
| `ContainerOutlined` | 内容管理 |

### 执行种子文件

```bash
# 方式一：仅运行种子（使用 upsert，不会覆盖已有数据）
pnpm db:seed

# 方式二：完全重置数据库（⚠️ 会清空所有数据）
pnpm db:migrate reset
```

> **注意**: 种子文件使用 `upsert` 操作，已存在的记录不会被覆盖，只会插入新记录。

### 角色权限分配

种子文件中已包含自动为管理员角色分配所有菜单权限的逻辑：

```typescript
// 给管理员角色分配所有菜单权限
const allMenus = await prisma.sysMenu.findMany({ where: { deleted: false } });
for (const menu of allMenus) {
  await prisma.sysRoleMenu.upsert({
    where: { roleId_menuId: { roleId: 1, menuId: menu.id } },
    update: {},
    create: {
      roleId: 1,
      menuId: menu.id,
    },
  });
}
```

这意味着新增的菜单会自动分配给 admin 角色（roleId: 1）。其他角色需要在后台「角色管理」中手动分配权限。

---

## 完整示例

以新增「文章管理」模块为例，需要创建的文件清单：

### 后端 (apps/admin-api)

```
prisma/
└── article.prisma                          # 数据模型

src/modules/article/
├── article.module.ts                       # 模块定义
├── article.controller.ts                   # 控制器
├── article.service.ts                      # 服务层
└── dto/
    ├── create-article.dto.ts              # 创建 DTO
    ├── update-article.dto.ts              # 更新 DTO
    └── query-article.dto.ts               # 查询 DTO
```

### 前端 (apps/admin-web)

```
src/
├── pages/article/
│   └── index.tsx                          # 列表页面
├── services/
│   └── article.ts                         # API 服务
└── constants/
    └── permissions.ts                     # 追加权限常量
```

### 配置步骤

1. 创建 Prisma 数据模型 (`prisma/article.prisma`)
2. 执行 `pnpm db:generate && pnpm db:migrate` 生成数据库表
3. 创建后端模块文件（module、controller、service、dto）
4. 在 `app.module.ts` 中导入新模块
5. 创建前端页面和 API 服务
6. 更新权限常量 (`src/constants/permissions.ts`)
7. **更新种子文件** (`prisma/seed.ts`)，添加菜单和按钮权限
8. 执行 `pnpm db:seed` 初始化菜单数据
9. 为其他角色分配新权限（admin 角色会自动获得）

---

## 权限标识规范

| 操作 | 权限标识 | 说明 |
|------|----------|------|
| 列表 | `module:list` | 查看列表 |
| 新增 | `module:add` | 创建记录 |
| 编辑 | `module:edit` | 修改记录 |
| 删除 | `module:remove` | 删除记录 |
| 查询 | `module:query` | 查看详情 |
| 导出 | `module:export` | 导出数据 |
| 导入 | `module:import` | 导入数据 |

---

## 常用命令

```bash
# 生成 Prisma Client
pnpm db:generate

# 执行数据库迁移
pnpm db:migrate

# 启动开发服务器
pnpm dev

# 仅启动后端
pnpm dev:api

# 仅启动前端
pnpm dev:web
```
