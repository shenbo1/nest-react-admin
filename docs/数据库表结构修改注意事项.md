# 数据库表结构修改注意事项

## 开发环境

### 1. 设计阶段
- **明确需求**：充分理解业务需求，避免频繁修改表结构
- **遵循命名规范**：使用统一的命名规则（如表名小写+下划线，字段名小写+下划线）
- **考虑扩展性**：为未来可能的业务扩展预留字段或设计灵活的结构
- **建立索引策略**：根据查询需求合理创建索引，避免过度索引

### 2. 修改阶段
- **使用Prisma Migrate**：通过Prisma的迁移系统管理表结构变更
- **创建迁移文件**：
  ```bash
  pnpm run db:migrate --name <migration-name>
  ```
- **保留旧字段**：暂时不要删除旧字段，确保所有应用代码都已迁移
- **测试变更**：在开发数据库上充分测试变更，包括CRUD操作和查询性能

### 3. 维护阶段
- **更新文档**：及时更新数据库文档和ER图
- **清理旧字段**：确认所有应用代码都已迁移后，再删除旧字段
- **备份数据库**：定期备份开发数据库，以便在出现问题时恢复

## 生产环境

### 1. 准备阶段
- **创建回滚计划**：制定详细的回滚策略，确保在变更失败时能够快速恢复
- **测试环境验证**：在测试环境完全复现生产环境配置，并测试所有变更
- **性能评估**：评估变更对性能的影响，特别是大表变更
- **通知相关人员**：提前通知开发、运维和业务团队变更计划

### 2. 执行阶段
- **选择合适的时间**：在业务低峰期执行变更，减少对用户的影响
- **备份数据库**：执行变更前一定要备份生产数据库
- **使用事务**：确保所有变更都在一个事务中完成，要么全部成功，要么全部失败
- **监控变更过程**：实时监控变更过程，及时发现并处理问题

### 3. 验证阶段
- **验证数据完整性**：确保变更后数据完整且正确
- **测试应用功能**：验证所有应用功能在生产环境中正常运行
- **监控性能**：持续监控数据库性能，确保变更没有影响系统性能
- **记录变更**：详细记录变更过程和结果，包括时间、人员和变更内容

## 新增字段注意事项
1. 为新增字段设置默认值，避免Null值问题
2. 对于大表，使用分批处理或在线DDL工具，避免长时间锁表
3. 为新增字段添加注释，说明字段用途
4. 确保新增字段的类型和长度符合业务需求

## 修改字段注意事项
1. 避免修改字段类型，特别是已经有大量数据的字段
2. 如果必须修改字段类型，确保数据可以顺利转换
3. 避免缩小字段长度，防止数据截断
4. 修改字段名时，确保所有引用该字段的代码都已更新

## 删除字段注意事项
1. 确保所有应用代码都不再使用该字段
2. 备份包含该字段的数据
3. 在删除字段前，先将其标记为 deprecated
4. 执行删除操作后，验证所有应用功能正常

## Prisma常用命令

### 命令说明速查

| 命令 | 说明 | 场景 |
|-----|------|------|
| `db:init` | 初始化 Prisma 项目 | 新项目初始化 |
| `db:generate` | 生成 Prisma 客户端代码 | schema 变更后必须执行 |
| `db:push` | 快速同步 schema 到数据库 | 开发快速迭代，不记录迁移历史 |
| `db:migrate dev` | 创建并应用迁移 | 开发环境，记录迁移历史 |
| `db:migrate:prod` | 应用迁移到生产环境 | 生产环境部署 |
| `db:seed` | 执行数据库种子数据 | 初始化测试数据 |
| `db:studio` | 启动 Prisma 可视化界面 | 查看和管理数据 |
| `db:reset` | 重置数据库（清空所有数据） | 危险！开发环境重置 |
| `db:drop` | 直接删除数据库 | 危险！彻底删除 |

### 项目根目录执行

```bash
# 初始化项目（首次）
pnpm run db:init

# 生成客户端代码（每次 schema 变更后必须执行）
pnpm run db:generate

# 快速同步（不生成迁移文件，适合开发快速迭代）
pnpm run db:push

# 创建迁移（生成迁移文件，可回滚）
pnpm run db:migrate --name <migration-name>

# 执行种子数据
pnpm run db:seed

# 启动可视化界面
pnpm run db:studio

# 重置数据库（清空所有数据！）
pnpm run db:reset
```

### admin-api目录执行

```bash
# 生成客户端代码
pnpm run db:generate

# 开发环境创建迁移
pnpm run db:migrate --name <migration-name>

# 生产环境应用迁移
pnpm run db:migrate:prod

# 快速同步（开发）
pnpm run db:push

# 执行种子数据
pnpm run db:seed

# 启动可视化界面
pnpm run db:studio

# 重置数据库（危险！）
pnpm run db:reset
```

### 工作流程

```bash
# 场景1：开发时快速修改 schema
# 1. 修改 schema.prisma
# 2. pnpm run db:push     # 同步到数据库
# 3. pnpm run db:generate # 生成客户端

# 场景2：正式功能修改（需要迁移记录）
# 1. 修改 schema.prisma
# 2. pnpm run db:migrate --name add_user_table  # 创建迁移
# 3. pnpm run db:generate                       # 生成客户端

# 场景3：生产环境部署
# 1. pnpm run db:migrate:prod  # 应用迁移
# 2. pnpm run db:generate      # 生成客户端
```

## Prisma特有注意事项
1. 确保schema.prisma文件是最新的
2. 避免在schema.prisma中重复定义模型或枚举
3. 使用prisma generate重新生成客户端代码
4. 确保所有模块文件中的定义与主schema.prisma一致
5. Prisma 6.x已弃用模块化架构，建议使用单个schema.prisma文件
