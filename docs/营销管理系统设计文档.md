# 营销管理系统设计文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    营销管理系统                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              前端展示层 (React)                               │   │
│  ├──────────────┬──────────────┬──────────────┬──────────────┬────────────────┤   │
│  │  优惠券管理   │   满减活动   │   促销活动   │   拼团管理   │   积分商城     │   │
│  │  ┌────────┐  │  ┌────────┐  │  ┌────────┐  │  ┌────────┐  │  ┌──────────┐  │   │
│  │  │券模板  │  │  │活动列表│  │  │秒杀    │  │  │拼团列表│  │  │积分规则  │  │   │
│  │  │用户券  │  │  │规则配置│  │  │限时折扣│  │  │团详情  │  │  │积分商品  │  │   │
│  │  │发放管理│  │  │商品关联│  │  │活动商品│  │  │成员管理│  │  │兑换记录  │  │   │
│  │  └────────┘  │  └────────┘  │  └────────┘  │  └────────┘  │  └──────────┘  │   │
│  └──────────────┴──────────────┴──────────────┴──────────────┴────────────────┘   │
│                                        │                                           │
│                                        ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              API 网关层 (NestJS)                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │   │
│  │  │ JWT 认证    │  │ 权限校验    │  │ 请求日志    │  │ 响应拦截器          │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                           │
│                                        ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              业务服务层 (Services)                            │   │
│  ├──────────────┬──────────────┬──────────────┬──────────────┬────────────────┤   │
│  │ CouponService│FullReduction │ Promotion    │ GroupBuy     │ Point          │   │
│  │              │ Service      │ Service      │ Service      │ Services       │   │
│  │ ┌──────────┐ │ ┌──────────┐ │ ┌──────────┐ │ ┌──────────┐ │ ┌────────────┐ │   │
│  │ │创建模板  │ │ │创建活动  │ │ │创建活动  │ │ │开团      │ │ │规则配置    │ │   │
│  │ │发放优惠券│ │ │规则计算  │ │ │库存扣减  │ │ │参团      │ │ │积分发放    │ │   │
│  │ │核销优惠券│ │ │状态管理  │ │ │价格计算  │ │ │成团判定  │ │ │积分兑换    │ │   │
│  │ │过期处理  │ │ │商品关联  │ │ │商品管理  │ │ │过期处理  │ │ │过期处理    │ │   │
│  │ └──────────┘ │ └──────────┘ │ └──────────┘ │ └──────────┘ │ └────────────┘ │   │
│  └──────────────┴──────────────┴──────────────┴──────────────┴────────────────┘   │
│                                        │                                           │
│                                        ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              数据访问层 (Prisma ORM)                          │   │
│  ├──────────────┬──────────────┬──────────────┬──────────────┬────────────────┤   │
│  │ CouponTemplate│FullReduction│ Promotion    │ GroupBuyOrder│ PointRule      │   │
│  │ MemberCoupon  │ Activity    │ Product      │ GroupBuyMember│PointProduct   │   │
│  │              │              │              │              │ PointExchange  │   │
│  │              │              │              │              │ MemberSignIn   │   │
│  └──────────────┴──────────────┴──────────────┴──────────────┴────────────────┘   │
│                                        │                                           │
│                                        ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              数据存储层                                       │   │
│  │  ┌─────────────────────────────┐    ┌─────────────────────────────────────┐  │   │
│  │  │       PostgreSQL            │    │              Redis                   │  │   │
│  │  │  ┌─────────────────────┐    │    │  ┌─────────────────────────────┐    │  │   │
│  │  │  │ 优惠券数据          │    │    │  │ 优惠券领取计数              │    │  │   │
│  │  │  │ 活动数据            │    │    │  │ 活动库存缓存                │    │  │   │
│  │  │  │ 积分数据            │    │    │  │ 拼团状态缓存                │    │  │   │
│  │  │  │ 订单关联            │    │    │  │ 签到状态缓存                │    │  │   │
│  │  │  └─────────────────────┘    │    │  └─────────────────────────────┘    │  │   │
│  │  └─────────────────────────────┘    └─────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 模块依赖关系图

```
                              ┌─────────────────┐
                              │   订单系统      │
                              │   (Order)       │
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│     优惠券系统      │    │     满减系统        │    │     积分系统        │
│  (Coupon System)    │    │ (FullReduction)     │    │  (Point System)     │
├─────────────────────┤    ├─────────────────────┤    ├─────────────────────┤
│ • 优惠券模板        │    │ • 满减活动          │    │ • 积分规则          │
│ • 用户优惠券        │    │ • 满减规则          │    │ • 积分商品          │
│ • 发放/核销         │    │ • 商品范围          │    │ • 兑换记录          │
└─────────────────────┘    └─────────────────────┘    │ • 签到记录          │
           │                           │              └─────────────────────┘
           │                           │                           │
           └───────────────┬───────────┘                           │
                           │                                       │
                           ▼                                       │
              ┌─────────────────────┐                              │
              │     促销系统        │                              │
              │ (Promotion System)  │◄─────────────────────────────┘
              ├─────────────────────┤
              │ • 秒杀活动          │
              │ • 限时折扣          │
              │ • 拼团活动          │
              │ • 活动商品          │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │     商品系统        │
              │    (Product)        │
              └─────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │     会员系统        │
              │    (Member)         │
              └─────────────────────┘
```

---

## 业务流程图

### 1. 优惠券业务流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              优惠券完整业务流程                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

                         ┌─────────────────┐
                         │   创建优惠券    │
                         │   模板          │
                         └────────┬────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
           ┌──────────────┐ ┌──────────┐ ┌──────────────┐
           │  用户领取    │ │ 系统发放 │ │  活动赠送    │
           │  (前台)      │ │ (后台)   │ │ (注册/首单)  │
           └──────┬───────┘ └────┬─────┘ └──────┬───────┘
                  │              │              │
                  └──────────────┼──────────────┘
                                 ▼
                    ┌─────────────────────────┐
                    │   生成用户优惠券        │
                    │   (计算有效期)          │
                    └────────────┬────────────┘
                                 │
                    ┌────────────┴────────────┐
                    ▼                         ▼
           ┌──────────────┐          ┌──────────────┐
           │  用户下单    │          │  优惠券过期  │
           │  选择优惠券  │          │  (定时任务)  │
           └──────┬───────┘          └──────┬───────┘
                  │                         │
                  ▼                         ▼
           ┌──────────────┐          ┌──────────────┐
           │  校验优惠券  │          │  标记为过期  │
           │  • 有效期    │          │  状态        │
           │  • 使用条件  │          └──────────────┘
           │  • 商品范围  │
           └──────┬───────┘
                  │
         ┌───────┴───────┐
         ▼               ▼
   ┌──────────┐    ┌──────────┐
   │ 校验通过 │    │ 校验失败 │
   └────┬─────┘    └────┬─────┘
        │               │
        ▼               ▼
   ┌──────────┐    ┌──────────┐
   │ 锁定优惠券│    │ 返回错误 │
   │ 计算抵扣 │    │ 提示信息 │
   └────┬─────┘    └──────────┘
        │
        ▼
   ┌──────────────┐
   │  支付成功    │
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │  核销优惠券  │
   │  标记已使用  │
   │  记录订单号  │
   └──────────────┘
```

### 2. 满减活动流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              满减活动业务流程                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

       ┌──────────────┐
       │ 创建满减活动 │
       │ 配置规则     │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │ 设置满减规则 │
       │ 满100减10    │
       │ 满200减30    │
       │ 满300减50    │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │ 设置商品范围 │
       │ • 全场通用   │
       │ • 指定分类   │
       │ • 指定商品   │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐         ┌──────────────┐
       │ 活动开始     │◄────────│ 定时任务     │
       │ 状态:进行中  │         │ 状态更新     │
       └──────┬───────┘         └──────────────┘
              │
              ▼
       ┌──────────────┐
       │ 用户加入购物车│
       │ 选择商品     │
       └──────┬───────┘
              │
              ▼
       ┌──────────────────────────────────┐
       │            结算页面               │
       │  ┌────────────────────────────┐  │
       │  │ 检查活动商品金额           │  │
       │  │         ▼                  │  │
       │  │ 匹配满减规则               │  │
       │  │         ▼                  │  │
       │  │ 计算优惠金额               │  │
       │  │         ▼                  │  │
       │  │ 显示满减优惠               │  │
       │  └────────────────────────────┘  │
       └──────────────┬───────────────────┘
                      │
                      ▼
              ┌──────────────┐
              │ 提交订单     │
              │ 记录优惠金额 │
              └──────────────┘
```

### 3. 促销活动流程（秒杀/限时折扣）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              秒杀/限时折扣流程                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

       ┌──────────────┐
       │ 创建促销活动 │
       │ 类型:秒杀    │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │ 添加活动商品 │
       │ • 活动价格   │
       │ • 活动库存   │
       │ • 限购数量   │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │ 活动预热     │
       │ 状态:未开始  │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐         ┌──────────────┐
       │ 活动开始     │◄────────│ 定时任务     │
       │ 状态:进行中  │         │ 自动开启     │
       └──────┬───────┘         └──────────────┘
              │
              ▼
       ┌──────────────────────────────────┐
       │            用户抢购               │
       │  ┌────────────────────────────┐  │
       │  │ 1. 检查活动状态            │  │
       │  │         ▼                  │  │
       │  │ 2. 检查库存                │  │
       │  │         ▼                  │  │
       │  │ 3. 检查限购数量            │  │
       │  │         ▼                  │  │
       │  │ 4. Redis锁定库存           │  │
       │  │         ▼                  │  │
       │  │ 5. 创建订单                │  │
       │  │         ▼                  │  │
       │  │ 6. 扣减数据库库存          │  │
       │  └────────────────────────────┘  │
       └──────────────┬───────────────────┘
                      │
         ┌────────────┼────────────┐
         ▼            ▼            ▼
   ┌──────────┐ ┌──────────┐ ┌──────────┐
   │ 抢购成功 │ │ 库存不足 │ │ 超出限购 │
   └────┬─────┘ └────┬─────┘ └────┬─────┘
        │            │            │
        ▼            ▼            ▼
   ┌──────────┐ ┌──────────┐ ┌──────────┐
   │ 去支付   │ │ 提示售罄 │ │ 提示超限 │
   └────┬─────┘ └──────────┘ └──────────┘
        │
   ┌────┴────┐
   ▼         ▼
┌──────┐  ┌──────┐
│支付  │  │超时  │
│成功  │  │未付款│
└──┬───┘  └──┬───┘
   │         │
   ▼         ▼
┌──────┐  ┌──────┐
│完成  │  │释放  │
│购买  │  │库存  │
└──────┘  └──────┘
```

### 4. 拼团业务流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              拼团业务流程                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │  创建拼团活动   │
                    │  • 成团人数     │
                    │  • 拼团价格     │
                    │  • 有效时长     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  活动上线       │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │   用户A开团     │          │   用户B参团     │
     │   (团长)        │          │   (团员)        │
     └────────┬────────┘          └────────┬────────┘
              │                             │
              ▼                             │
     ┌─────────────────┐                    │
     │  创建拼团订单   │                    │
     │  groupNo: xxx   │                    │
     │  status: WAITING│                    │
     └────────┬────────┘                    │
              │                             │
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │  团长支付订单   │          │  查找进行中的团 │
     └────────┬────────┘          └────────┬────────┘
              │                             │
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │  等待成团       │◄─────────│  加入拼团       │
     │  分享链接       │          │  创建参团订单   │
     └────────┬────────┘          └────────┬────────┘
              │                             │
              │         ┌───────────────────┘
              │         ▼
              │  ┌─────────────────┐
              │  │  团员支付订单   │
              │  └────────┬────────┘
              │           │
              └─────┬─────┘
                    ▼
           ┌─────────────────┐
           │  检查成团人数   │
           │  currentCount   │
           └────────┬────────┘
                    │
         ┌──────────┴──────────┐
         ▼                     ▼
  ┌─────────────┐       ┌─────────────┐
  │ 人数已满    │       │ 人数不足    │
  │ 成团成功    │       │ 继续等待    │
  └──────┬──────┘       └──────┬──────┘
         │                     │
         ▼                     ▼
  ┌─────────────┐       ┌─────────────┐
  │status:SUCCESS│      │ 等待超时?   │
  │ 订单生效    │       └──────┬──────┘
  │ 通知所有人  │              │
  └─────────────┘       ┌──────┴──────┐
                        ▼             ▼
                 ┌──────────┐  ┌──────────┐
                 │ 继续等待 │  │ 拼团失败 │
                 └──────────┘  │ 自动退款 │
                               └──────────┘
```

### 5. 积分商城流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              积分商城业务流程                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              积分获取                                           │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐     │
│  │  签到    │   │  消费    │   │  注册    │   │  首单    │   │ 系统调整 │     │
│  │  送积分  │   │  送积分  │   │  送积分  │   │  送积分  │   │          │     │
│  └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘     │
│       │              │              │              │              │           │
│       └──────────────┴──────────────┴──────────────┴──────────────┘           │
│                                     │                                         │
│                                     ▼                                         │
│                          ┌─────────────────┐                                  │
│                          │  积分入账       │                                  │
│                          │  记录流水       │                                  │
│                          │  设置过期时间   │                                  │
│                          └─────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              积分使用                                           │
│                                                                                 │
│       ┌─────────────────┐                    ┌─────────────────┐               │
│       │  积分兑换商品   │                    │  积分抵扣订单   │               │
│       └────────┬────────┘                    └────────┬────────┘               │
│                │                                      │                        │
│                ▼                                      ▼                        │
│       ┌─────────────────┐                    ┌─────────────────┐               │
│       │ 1. 检查积分余额 │                    │ 1. 检查积分余额 │               │
│       │ 2. 检查商品库存 │                    │ 2. 计算可抵扣额 │               │
│       │ 3. 检查限兑数量 │                    │ 3. 扣减积分     │               │
│       └────────┬────────┘                    │ 4. 减少订单金额 │               │
│                │                             └─────────────────┘               │
│                ▼                                                               │
│       ┌─────────────────┐                                                      │
│       │ 4. 扣减积分     │                                                      │
│       │ 5. 扣减库存     │                                                      │
│       │ 6. 创建兑换记录 │                                                      │
│       └────────┬────────┘                                                      │
│                │                                                               │
│       ┌────────┴────────┐                                                      │
│       ▼                 ▼                                                      │
│  ┌─────────┐      ┌─────────┐                                                  │
│  │ 实物商品│      │ 虚拟商品│                                                  │
│  │ 等待发货│      │ 即时发放│                                                  │
│  └────┬────┘      └────┬────┘                                                  │
│       │                │                                                       │
│       ▼                ▼                                                       │
│  ┌─────────┐      ┌─────────┐                                                  │
│  │ 发货    │      │ 发放优惠│                                                  │
│  │ 物流跟踪│      │ 券到账  │                                                  │
│  └────┬────┘      └─────────┘                                                  │
│       │                                                                        │
│       ▼                                                                        │
│  ┌─────────┐                                                                   │
│  │ 确认收货│                                                                   │
│  │ 完成兑换│                                                                   │
│  └─────────┘                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              积分过期处理 (定时任务)                             │
│                                                                                 │
│       ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐      │
│       │ 查询过期积分    │────▶│ 扣减会员积分    │────▶│ 记录过期流水    │      │
│       │ expireTime < now│     │ 更新积分余额    │     │ source: EXPIRE  │      │
│       └─────────────────┘     └─────────────────┘     └─────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6. 签到送积分流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              签到送积分流程                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   用户点击签到  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查今日是否    │
                    │ 已签到          │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │   已签到        │          │   未签到        │
     │   返回提示      │          └────────┬────────┘
     └─────────────────┘                   │
                                           ▼
                                  ┌─────────────────┐
                                  │ 查询昨日签到    │
                                  │ 记录            │
                                  └────────┬────────┘
                                           │
                            ┌──────────────┴──────────────┐
                            ▼                             ▼
                   ┌─────────────────┐          ┌─────────────────┐
                   │ 连续签到        │          │ 断签            │
                   │ consecutiveDays │          │ consecutiveDays │
                   │ + 1             │          │ = 1             │
                   └────────┬────────┘          └────────┬────────┘
                            │                            │
                            └──────────┬─────────────────┘
                                       │
                                       ▼
                            ┌─────────────────┐
                            │ 计算签到积分    │
                            │ (连续签到奖励) │
                            │ 第1天: 10分     │
                            │ 第2天: 15分     │
                            │ 第3天: 20分     │
                            │ 第7天: 50分     │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 创建签到记录    │
                            │ 增加会员积分    │
                            │ 记录积分流水    │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 返回签到成功    │
                            │ 显示获得积分    │
                            │ 显示连续天数    │
                            └─────────────────┘
```

---

## 一、需求概述

为现有商城后台管理系统添加完整的营销管理模块，包含以下四大功能：

### 1. 优惠券管理
- **券类型**：满减券、折扣券、无门槛券
- **发放方式**：用户领取、系统发放、活动赠送（注册/首单）
- **商品限制**：支持指定适用商品/分类，或排除某些商品

### 2. 满减活动
- 满XX元减XX元的促销活动
- 支持多级满减规则（如满100减10，满200减30）
- 支持商品限制（指定商品/分类或全场通用）

### 3. 促销活动
- **秒杀**：限时限量抢购
- **限时折扣**：特定时间段内的折扣
- **拼团**：多人成团享优惠

### 4. 积分商城（完整版）
- 积分规则配置（签到送积分、消费送积分）
- 积分过期机制
- 积分兑换商品
- 积分记录查询

---

## 二、数据库模型设计

### 2.1 新增枚举类型

```prisma
// 优惠券类型
enum CouponType {
  FULL_REDUCTION  // 满减券
  DISCOUNT        // 折扣券
  NO_THRESHOLD    // 无门槛券
}

// 优惠券获取方式
enum CouponGrantType {
  USER_CLAIM      // 用户领取
  SYSTEM_GRANT    // 系统发放
  REGISTER        // 注册赠送
  FIRST_ORDER     // 首单赠送
  ACTIVITY        // 活动赠送
}

// 用户优惠券状态
enum MemberCouponStatus {
  UNUSED          // 未使用
  USED            // 已使用
  EXPIRED         // 已过期
  FROZEN          // 已冻结
}

// 活动状态
enum PromotionStatus {
  NOT_STARTED     // 未开始
  RUNNING         // 进行中
  ENDED           // 已结束
  DISABLED        // 已禁用
}

// 促销活动类型
enum PromotionType {
  FLASH_SALE      // 秒杀
  TIME_DISCOUNT   // 限时折扣
  GROUP_BUY       // 拼团
}

// 积分变动来源
enum PointSource {
  SIGN_IN         // 签到
  CONSUME         // 消费
  EXCHANGE        // 兑换
  SYSTEM_ADJUST   // 系统调整
  EXPIRE          // 过期
  REFUND          // 退款返还
}
```

### 2.2 数据表设计

#### 2.2.1 优惠券模板表 (marketing_coupon_template)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| name | String(100) | 优惠券名称 |
| code | String(50) | 优惠券编码（唯一） |
| type | CouponType | 优惠券类型 |
| grantType | CouponGrantType | 获取方式 |
| value | Decimal(10,2) | 面额/折扣值 |
| minAmount | Decimal(10,2) | 使用门槛金额 |
| maxDiscount | Decimal(10,2)? | 最大折扣金额（折扣券专用） |
| totalCount | Int | 发行总量（-1无限） |
| receivedCount | Int | 已领取数量 |
| usedCount | Int | 已使用数量 |
| perLimitCount | Int | 每人限领数量 |
| validType | String(20) | 有效期类型：FIXED/DAYS |
| startTime | DateTime? | 固定开始时间 |
| endTime | DateTime? | 固定结束时间 |
| validDays | Int? | 有效天数 |
| scopeType | String(20) | 适用范围：ALL/CATEGORY/PRODUCT/EXCLUDE |
| scopeIds | Json? | 适用ID列表 |
| excludeIds | Json? | 排除ID列表 |
| status | Status | 状态 |
| description | String(500)? | 使用说明 |

#### 2.2.2 用户优惠券表 (marketing_member_coupon)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| memberId | Int | 会员ID |
| templateId | Int | 优惠券模板ID |
| couponCode | String(50) | 优惠券码（唯一） |
| status | MemberCouponStatus | 状态 |
| receiveTime | DateTime | 领取时间 |
| validStartTime | DateTime | 有效开始时间 |
| validEndTime | DateTime | 有效结束时间 |
| useTime | DateTime? | 使用时间 |
| orderId | Int? | 使用订单ID |
| orderNo | String(50)? | 使用订单号 |
| discountAmount | Decimal(10,2)? | 实际抵扣金额 |

#### 2.2.3 满减活动表 (marketing_full_reduction)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| name | String(100) | 活动名称 |
| code | String(50) | 活动编码 |
| rules | Json | 满减规则 [{minAmount, reduceAmount}] |
| stackable | Boolean | 是否可叠加 |
| startTime | DateTime | 开始时间 |
| endTime | DateTime | 结束时间 |
| scopeType | String(20) | 适用范围 |
| scopeIds | Json? | 适用ID列表 |
| status | PromotionStatus | 状态 |
| description | String(500)? | 活动描述 |

#### 2.2.4 促销活动表 (marketing_promotion)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| name | String(100) | 活动名称 |
| code | String(50) | 活动编码 |
| type | PromotionType | 活动类型 |
| startTime | DateTime | 开始时间 |
| endTime | DateTime | 结束时间 |
| status | PromotionStatus | 状态 |
| coverImage | String(500)? | 封面图 |
| ruleConfig | Json? | 规则配置 |
| description | String(500)? | 活动描述 |

#### 2.2.5 促销活动商品表 (marketing_promotion_product)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| activityId | Int | 活动ID |
| productId | Int | 商品ID |
| skuId | Int? | SKU ID |
| activityPrice | Decimal(10,2) | 活动价格 |
| activityStock | Int | 活动库存 |
| soldCount | Int | 已售数量 |
| limitCount | Int | 每人限购 |
| sort | Int | 排序 |
| status | Status | 状态 |

#### 2.2.6 拼团订单表 (marketing_group_buy_order)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| groupNo | String(50) | 团单号 |
| activityId | Int | 活动ID |
| productId | Int | 商品ID |
| skuId | Int? | SKU ID |
| leaderId | Int | 团长会员ID |
| requiredCount | Int | 成团人数要求 |
| currentCount | Int | 当前人数 |
| groupPrice | Decimal(10,2) | 拼团价格 |
| status | String(20) | 状态：WAITING/SUCCESS/FAILED |
| startTime | DateTime | 开团时间 |
| expireTime | DateTime | 截止时间 |
| successTime | DateTime? | 成团时间 |

#### 2.2.7 拼团成员表 (marketing_group_buy_member)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| groupOrderId | Int | 团单ID |
| memberId | Int | 会员ID |
| isLeader | Boolean | 是否团长 |
| orderId | Int? | 参团订单ID |
| joinTime | DateTime | 参团时间 |

#### 2.2.8 积分规则表 (marketing_point_rule)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| code | String(50) | 规则编码 |
| name | String(100) | 规则名称 |
| type | String(30) | 规则类型：SIGN_IN/CONSUME/REGISTER/FIRST_ORDER |
| points | Int | 赠送积分数量 |
| consumeUnit | Decimal(10,2)? | 消费金额单位（每X元送points积分） |
| dailyLimit | Int | 每日上限（0无限制） |
| validDays | Int | 积分有效期（天，0永不过期） |
| status | Status | 状态 |
| description | String(500)? | 规则说明 |

#### 2.2.9 积分商品表 (marketing_point_product)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| name | String(100) | 商品名称 |
| code | String(50) | 商品编码 |
| image | String(500)? | 商品图片 |
| points | Int | 兑换所需积分 |
| stock | Int | 库存 |
| exchangedCount | Int | 已兑换数量 |
| limitCount | Int | 每人限兑数量 |
| startTime | DateTime? | 兑换开始时间 |
| endTime | DateTime? | 兑换结束时间 |
| productType | String(20) | 类型：PHYSICAL/VIRTUAL/COUPON |
| relatedProductId | Int? | 关联商品ID |
| relatedCouponId | Int? | 关联优惠券ID |
| sort | Int | 排序 |
| status | Status | 状态 |
| description | String(500)? | 商品描述 |

#### 2.2.10 积分兑换记录表 (marketing_point_exchange_record)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| exchangeNo | String(50) | 兑换单号 |
| memberId | Int | 会员ID |
| pointProductId | Int | 积分商品ID |
| quantity | Int | 兑换数量 |
| points | Int | 消耗积分 |
| status | String(20) | 状态：PENDING/SHIPPED/COMPLETED/CANCELLED |
| addressInfo | Json? | 收货地址信息 |
| shippingInfo | Json? | 物流信息 |

#### 2.2.11 会员签到记录表 (marketing_member_sign_in)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Int | 主键 |
| memberId | Int | 会员ID |
| signDate | Date | 签到日期 |
| points | Int | 获得积分 |
| consecutiveDays | Int | 连续签到天数 |

---

## 三、菜单权限规划

### 3.1 菜单结构

菜单 ID 规划：营销管理使用 **600-699** 范围

```
营销管理 (600) - 一级目录
├── 优惠券管理 (601)
├── 用户优惠券 (602)
├── 满减活动 (603)
├── 促销活动 (604)
├── 拼团管理 (605)
├── 积分规则 (606)
├── 积分商品 (607)
└── 兑换记录 (608)
```

### 3.2 权限标识

| 模块 | 权限前缀 | 按钮权限 |
|------|----------|----------|
| 优惠券管理 | `marketing:coupon` | query/add/edit/remove/grant |
| 用户优惠券 | `marketing:member-coupon` | list/query/freeze |
| 满减活动 | `marketing:full-reduction` | query/add/edit/remove |
| 促销活动 | `marketing:promotion` | query/add/edit/remove/product |
| 拼团管理 | `marketing:group-buy` | list/query/close |
| 积分规则 | `marketing:point-rule` | query/add/edit/remove |
| 积分商品 | `marketing:point-product` | query/add/edit/remove |
| 兑换记录 | `marketing:point-exchange` | list/query/ship |

### 3.3 seed.ts 菜单定义

```typescript
// 营销管理模块
dir(600, 0, '营销管理', '/marketing', 'GiftOutlined', 'marketing:manage', 7),
menu(601, 600, '优惠券管理', '/marketing/coupon', 'marketing/coupon/index', 'CreditCardOutlined', 'marketing:coupon:list', 1),
menu(602, 600, '用户优惠券', '/marketing/member-coupon', 'marketing/member-coupon/index', 'IdcardOutlined', 'marketing:member-coupon:list', 2),
menu(603, 600, '满减活动', '/marketing/full-reduction', 'marketing/full-reduction/index', 'PercentageOutlined', 'marketing:full-reduction:list', 3),
menu(604, 600, '促销活动', '/marketing/promotion', 'marketing/promotion/index', 'FireOutlined', 'marketing:promotion:list', 4),
menu(605, 600, '拼团管理', '/marketing/group-buy', 'marketing/group-buy/index', 'TeamOutlined', 'marketing:group-buy:list', 5),
menu(606, 600, '积分规则', '/marketing/point-rule', 'marketing/point-rule/index', 'StarOutlined', 'marketing:point-rule:list', 6),
menu(607, 600, '积分商品', '/marketing/point-product', 'marketing/point-product/index', 'ShoppingOutlined', 'marketing:point-product:list', 7),
menu(608, 600, '兑换记录', '/marketing/point-exchange', 'marketing/point-exchange/index', 'HistoryOutlined', 'marketing:point-exchange:list', 8),

// 按钮权限
buttons(610, 601, '优惠券', 'marketing:coupon', { query: true, add: true, edit: true, remove: true }),
button(615, 601, '发放优惠券', 'marketing:coupon:grant'),

button(620, 602, '用户券查询', 'marketing:member-coupon:query'),
button(621, 602, '冻结优惠券', 'marketing:member-coupon:freeze'),

buttons(625, 603, '满减', 'marketing:full-reduction', { query: true, add: true, edit: true, remove: true }),

buttons(630, 604, '促销', 'marketing:promotion', { query: true, add: true, edit: true, remove: true }),
button(635, 604, '管理活动商品', 'marketing:promotion:product'),

button(640, 605, '拼团查询', 'marketing:group-buy:query'),
button(641, 605, '关闭拼团', 'marketing:group-buy:close'),

buttons(645, 606, '积分规则', 'marketing:point-rule', { query: true, add: true, edit: true, remove: true }),

buttons(650, 607, '积分商品', 'marketing:point-product', { query: true, add: true, edit: true, remove: true }),

button(655, 608, '兑换记录查询', 'marketing:point-exchange:query'),
button(656, 608, '发货', 'marketing:point-exchange:ship'),
```

---

## 四、后端模块结构

### 4.1 目录结构

```
apps/admin-api/src/modules/marketing/
├── marketing.module.ts              # 营销模块入口
├── coupon/                          # 优惠券管理
│   ├── coupon.module.ts
│   ├── coupon.controller.ts
│   ├── coupon.service.ts
│   └── dto/
│       ├── create-coupon.dto.ts
│       ├── update-coupon.dto.ts
│       ├── query-coupon.dto.ts
│       └── grant-coupon.dto.ts
├── member-coupon/                   # 用户优惠券
│   ├── member-coupon.module.ts
│   ├── member-coupon.controller.ts
│   ├── member-coupon.service.ts
│   └── dto/
│       └── query-member-coupon.dto.ts
├── full-reduction/                  # 满减活动
│   ├── full-reduction.module.ts
│   ├── full-reduction.controller.ts
│   ├── full-reduction.service.ts
│   └── dto/
│       ├── create-full-reduction.dto.ts
│       ├── update-full-reduction.dto.ts
│       └── query-full-reduction.dto.ts
├── promotion/                       # 促销活动
│   ├── promotion.module.ts
│   ├── promotion.controller.ts
│   ├── promotion.service.ts
│   └── dto/
│       ├── create-promotion.dto.ts
│       ├── update-promotion.dto.ts
│       ├── query-promotion.dto.ts
│       └── promotion-product.dto.ts
├── group-buy/                       # 拼团管理
│   ├── group-buy.module.ts
│   ├── group-buy.controller.ts
│   ├── group-buy.service.ts
│   └── dto/
│       └── query-group-buy.dto.ts
├── point-rule/                      # 积分规则
│   ├── point-rule.module.ts
│   ├── point-rule.controller.ts
│   ├── point-rule.service.ts
│   └── dto/
│       ├── create-point-rule.dto.ts
│       ├── update-point-rule.dto.ts
│       └── query-point-rule.dto.ts
├── point-product/                   # 积分商品
│   ├── point-product.module.ts
│   ├── point-product.controller.ts
│   ├── point-product.service.ts
│   └── dto/
│       ├── create-point-product.dto.ts
│       ├── update-point-product.dto.ts
│       └── query-point-product.dto.ts
└── point-exchange/                  # 积分兑换记录
    ├── point-exchange.module.ts
    ├── point-exchange.controller.ts
    ├── point-exchange.service.ts
    └── dto/
        └── query-point-exchange.dto.ts
```

### 4.2 Controller 示例（优惠券）

```typescript
@Controller('marketing/coupon')
export class CouponController {
  constructor(
    private readonly couponService: CouponService,
    private readonly cls: ClsService,
  ) {}

  @Post()
  @RequirePermissions('marketing:coupon:add')
  create(@Body() createDto: CreateCouponDto) {
    const userId = this.cls.get('user').id;
    return this.couponService.create(createDto, userId);
  }

  @Get()
  @RequirePermissions('marketing:coupon:list')
  findAll(@Query() query: QueryCouponDto) {
    return this.couponService.findAll(query);
  }

  @Get(':id')
  @RequirePermissions('marketing:coupon:query')
  findOne(@Param('id', ParseIntPipe) id: number) {
    return this.couponService.findOne(id);
  }

  @Put(':id')
  @RequirePermissions('marketing:coupon:edit')
  update(@Param('id', ParseIntPipe) id: number, @Body() updateDto: UpdateCouponDto) {
    const userId = this.cls.get('user').id;
    return this.couponService.update(id, updateDto, userId);
  }

  @Delete(':id')
  @RequirePermissions('marketing:coupon:remove')
  remove(@Param('id', ParseIntPipe) id: number) {
    const userId = this.cls.get('user').id;
    return this.couponService.remove(id, userId);
  }

  @Post(':id/grant')
  @RequirePermissions('marketing:coupon:grant')
  grantCoupon(@Param('id', ParseIntPipe) id: number, @Body() grantDto: GrantCouponDto) {
    const userId = this.cls.get('user').id;
    return this.couponService.grantCoupon(id, grantDto, userId);
  }

  @Put(':id/toggle-status')
  @RequirePermissions('marketing:coupon:edit')
  toggleStatus(@Param('id', ParseIntPipe) id: number) {
    const userId = this.cls.get('user').id;
    return this.couponService.toggleStatus(id, userId);
  }
}
```

---

## 五、前端模块结构

### 5.1 目录结构

```
apps/admin-web/src/
├── pages/marketing/
│   ├── coupon/index.tsx             # 优惠券管理
│   ├── member-coupon/index.tsx      # 用户优惠券
│   ├── full-reduction/index.tsx     # 满减活动
│   ├── promotion/index.tsx          # 促销活动
│   ├── group-buy/index.tsx          # 拼团管理
│   ├── point-rule/index.tsx         # 积分规则
│   ├── point-product/index.tsx      # 积分商品
│   └── point-exchange/index.tsx     # 兑换记录
├── services/marketing/
│   ├── coupon.ts
│   ├── member-coupon.ts
│   ├── full-reduction.ts
│   ├── promotion.ts
│   ├── group-buy.ts
│   ├── point-rule.ts
│   ├── point-product.ts
│   └── point-exchange.ts
└── constants/permissions.ts          # 添加 MARKETING 权限
```

### 5.2 权限常量

```typescript
// apps/admin-web/src/constants/permissions.ts
export const MARKETING = {
  MANAGE: 'marketing:manage',
  COUPON: {
    LIST: 'marketing:coupon:list',
    ADD: 'marketing:coupon:add',
    EDIT: 'marketing:coupon:edit',
    REMOVE: 'marketing:coupon:remove',
    QUERY: 'marketing:coupon:query',
    GRANT: 'marketing:coupon:grant',
  },
  MEMBER_COUPON: {
    LIST: 'marketing:member-coupon:list',
    QUERY: 'marketing:member-coupon:query',
    FREEZE: 'marketing:member-coupon:freeze',
  },
  FULL_REDUCTION: {
    LIST: 'marketing:full-reduction:list',
    ADD: 'marketing:full-reduction:add',
    EDIT: 'marketing:full-reduction:edit',
    REMOVE: 'marketing:full-reduction:remove',
    QUERY: 'marketing:full-reduction:query',
  },
  PROMOTION: {
    LIST: 'marketing:promotion:list',
    ADD: 'marketing:promotion:add',
    EDIT: 'marketing:promotion:edit',
    REMOVE: 'marketing:promotion:remove',
    QUERY: 'marketing:promotion:query',
    PRODUCT: 'marketing:promotion:product',
  },
  GROUP_BUY: {
    LIST: 'marketing:group-buy:list',
    QUERY: 'marketing:group-buy:query',
    CLOSE: 'marketing:group-buy:close',
  },
  POINT_RULE: {
    LIST: 'marketing:point-rule:list',
    ADD: 'marketing:point-rule:add',
    EDIT: 'marketing:point-rule:edit',
    REMOVE: 'marketing:point-rule:remove',
    QUERY: 'marketing:point-rule:query',
  },
  POINT_PRODUCT: {
    LIST: 'marketing:point-product:list',
    ADD: 'marketing:point-product:add',
    EDIT: 'marketing:point-product:edit',
    REMOVE: 'marketing:point-product:remove',
    QUERY: 'marketing:point-product:query',
  },
  POINT_EXCHANGE: {
    LIST: 'marketing:point-exchange:list',
    QUERY: 'marketing:point-exchange:query',
    SHIP: 'marketing:point-exchange:ship',
  },
} as const;
```

### 5.3 API 服务示例

```typescript
// apps/admin-web/src/services/marketing/coupon.ts
import request from '@/utils/request';

export interface CouponTemplate {
  id: number;
  name: string;
  code: string;
  type: 'FULL_REDUCTION' | 'DISCOUNT' | 'NO_THRESHOLD';
  grantType: 'USER_CLAIM' | 'SYSTEM_GRANT' | 'REGISTER' | 'FIRST_ORDER' | 'ACTIVITY';
  value: number;
  minAmount: number;
  maxDiscount?: number;
  totalCount: number;
  receivedCount: number;
  usedCount: number;
  perLimitCount: number;
  validType: 'FIXED' | 'DAYS';
  startTime?: string;
  endTime?: string;
  validDays?: number;
  scopeType: 'ALL' | 'CATEGORY' | 'PRODUCT' | 'EXCLUDE';
  scopeIds?: number[];
  excludeIds?: number[];
  status: 'ENABLED' | 'DISABLED';
  description?: string;
  createdAt: string;
}

export const couponApi = {
  list(params?: CouponQuery) {
    return request.get<{ data: CouponTemplate[]; total: number }>(
      '/marketing/coupon', { params }
    );
  },
  get(id: number) {
    return request.get<CouponTemplate>(`/marketing/coupon/${id}`);
  },
  create(data: CreateCouponDto) {
    return request.post<CouponTemplate>('/marketing/coupon', data);
  },
  update(id: number, data: Partial<CreateCouponDto>) {
    return request.put<CouponTemplate>(`/marketing/coupon/${id}`, data);
  },
  delete(id: number) {
    return request.delete(`/marketing/coupon/${id}`);
  },
  toggleStatus(id: number) {
    return request.put(`/marketing/coupon/${id}/toggle-status`);
  },
  grant(id: number, data: { memberIds: number[] }) {
    return request.post(`/marketing/coupon/${id}/grant`, data);
  },
};
```

---

## 六、开发优先级

按照模块复杂度、依赖关系和业务价值，从低到高排列开发优先级：

| 优先级 | 模块 | 理由 |
|--------|------|------|
| **P0 (最高)** | 基础架构 | 数据库模型、菜单权限、权限常量 - 所有模块的前置依赖 |
| **P0 (最高)** | 优惠券管理 | 核心模块，其他模块（活动赠送）依赖它，业务逻辑清晰 |
| **P1** | 用户优惠券 | 依赖优惠券模板，主要是查询和状态管理，逻辑简单 |
| **P1** | 积分规则 | 基础配置模块，为积分商品和兑换提供规则支持 |
| **P2** | 满减活动 | 相对独立，规则配置简单，核心是订单结算时的价格计算 |
| **P2** | 积分商品 | 依赖积分规则模块，需要关联实物/虚拟商品/优惠券 |
| **P3** | 积分兑换记录 | 依赖积分商品模块，涉及发货、物流等后续流程 |
| **P4** | 促销活动（秒杀/限时折扣） | 需要高并发库存控制、Redis 锁定、定时任务，技术难度较高 |
| **P5 (最低)** | 拼团管理 | 业务逻辑最复杂（开团、参团、成团判定、超时退款），依赖订单和支付系统 |

### 建议开发路线

```
P0: 基础架构 + 优惠券管理
     ↓
P1: 用户优惠券 + 积分规则
     ↓
P2: 满减活动 + 积分商品
     ↓
P3: 积分兑换记录
     ↓
P4: 促销活动（秒杀/限时折扣）
     ↓
P5: 拼团管理
```

---

## 七、实现步骤

### 阶段一：基础架构

| 步骤 | 任务 | 文件 |
|------|------|------|
| 1 | 添加数据库模型 | `apps/admin-api/prisma/schema.prisma` |
| 2 | 生成 Prisma Client | `pnpm db:generate && pnpm db:push` |
| 3 | 添加菜单权限 | `apps/admin-api/prisma/seed.ts` |
| 4 | 添加前端权限常量 | `apps/admin-web/src/constants/permissions.ts` |

### 阶段二：优惠券模块

| 步骤 | 任务 | 文件 |
|------|------|------|
| 5 | 创建优惠券后端模块 | `modules/marketing/coupon/*` |
| 6 | 创建用户优惠券后端模块 | `modules/marketing/member-coupon/*` |
| 7 | 创建优惠券前端服务 | `services/marketing/coupon.ts` |
| 8 | 创建优惠券管理页面 | `pages/marketing/coupon/index.tsx` |
| 9 | 创建用户优惠券页面 | `pages/marketing/member-coupon/index.tsx` |

### 阶段三：满减活动

| 步骤 | 任务 | 文件 |
|------|------|------|
| 10 | 创建满减后端模块 | `modules/marketing/full-reduction/*` |
| 11 | 创建满减前端服务 | `services/marketing/full-reduction.ts` |
| 12 | 创建满减管理页面 | `pages/marketing/full-reduction/index.tsx` |

### 阶段四：促销活动

| 步骤 | 任务 | 文件 |
|------|------|------|
| 13 | 创建促销活动后端模块 | `modules/marketing/promotion/*` |
| 14 | 创建拼团后端模块 | `modules/marketing/group-buy/*` |
| 15 | 创建促销前端服务 | `services/marketing/promotion.ts` |
| 16 | 创建促销活动页面 | `pages/marketing/promotion/index.tsx` |
| 17 | 创建拼团管理页面 | `pages/marketing/group-buy/index.tsx` |

### 阶段五：积分商城

| 步骤 | 任务 | 文件 |
|------|------|------|
| 18 | 创建积分规则后端模块 | `modules/marketing/point-rule/*` |
| 19 | 创建积分商品后端模块 | `modules/marketing/point-product/*` |
| 20 | 创建积分兑换后端模块 | `modules/marketing/point-exchange/*` |
| 21 | 创建积分前端服务 | `services/marketing/point-*.ts` |
| 22 | 创建积分规则页面 | `pages/marketing/point-rule/index.tsx` |
| 23 | 创建积分商品页面 | `pages/marketing/point-product/index.tsx` |
| 24 | 创建兑换记录页面 | `pages/marketing/point-exchange/index.tsx` |

### 阶段六：集成配置

| 步骤 | 任务 | 文件 |
|------|------|------|
| 25 | 注册营销模块 | `apps/admin-api/src/app.module.ts` |
| 26 | 添加前端路由 | `apps/admin-web/src/App.tsx` |
| 27 | 添加菜单配置 | `apps/admin-web/src/layouts/BasicLayout.tsx` |

---

## 七、关键文件清单

### 需要修改的现有文件

| 文件 | 修改内容 |
|------|----------|
| `apps/admin-api/prisma/schema.prisma` | 添加营销相关枚举和11张数据表 |
| `apps/admin-api/prisma/seed.ts` | 添加营销菜单（600-608）和按钮权限（610-659） |
| `apps/admin-api/src/app.module.ts` | 导入 MarketingModule |
| `apps/admin-web/src/constants/permissions.ts` | 添加 MARKETING 权限常量 |
| `apps/admin-web/src/App.tsx` | 添加营销模块路由 |
| `apps/admin-web/src/layouts/BasicLayout.tsx` | 添加营销菜单项 |

### 需要新建的文件

**后端**（约 40+ 个文件）：
- `apps/admin-api/src/modules/marketing/marketing.module.ts`
- 8 个子模块目录，每个包含 module/controller/service/dto

**前端**（约 16 个文件）：
- 8 个服务文件：`apps/admin-web/src/services/marketing/*.ts`
- 8 个页面文件：`apps/admin-web/src/pages/marketing/*/index.tsx`

---

## 八、注意事项

1. **遵循现有代码规范**
   - Controller 使用 `@RequirePermissions` 装饰器
   - Service 使用软删除（deleted/deletedAt）
   - 前端使用 ProTable + ModalForm 模式

2. **权限 ID 规划**
   - 营销模块使用 600-699 范围
   - 避免与现有模块冲突（系统 10-99，商城 200-299，会员 500-599）

3. **商品限制功能**
   - 优惠券和活动都支持 `scopeType` + `scopeIds` 做商品范围限制
   - 支持四种范围：全部商品、指定分类、指定商品、排除商品

4. **积分过期机制**
   - 积分规则配置 `validDays` 有效期
   - 需要定时任务处理过期积分

---

## 九、定时任务设计

营销系统需要以下定时任务支持：

| 任务名称 | 执行频率 | 功能说明 |
|----------|----------|----------|
| 优惠券过期处理 | 每天凌晨1点 | 将过期的用户优惠券状态更新为 EXPIRED |
| 活动状态更新 | 每分钟 | 根据开始/结束时间自动更新活动状态（NOT_STARTED → RUNNING → ENDED） |
| 拼团过期处理 | 每分钟 | 检查超时未成团的拼团订单，自动退款 |
| 积分过期处理 | 每天凌晨2点 | 扣减过期积分，记录过期流水 |
| 优惠券到期提醒 | 每天上午10点 | 推送即将过期（3天内）的优惠券提醒 |

---

## 十、API 接口清单

### 10.1 优惠券模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/coupon | 优惠券列表 | marketing:coupon:list |
| GET | /marketing/coupon/:id | 优惠券详情 | marketing:coupon:query |
| POST | /marketing/coupon | 创建优惠券 | marketing:coupon:add |
| PUT | /marketing/coupon/:id | 更新优惠券 | marketing:coupon:edit |
| DELETE | /marketing/coupon/:id | 删除优惠券 | marketing:coupon:remove |
| PUT | /marketing/coupon/:id/toggle-status | 切换状态 | marketing:coupon:edit |
| POST | /marketing/coupon/:id/grant | 发放优惠券 | marketing:coupon:grant |

### 10.2 用户优惠券模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/member-coupon | 用户优惠券列表 | marketing:member-coupon:list |
| GET | /marketing/member-coupon/:id | 用户券详情 | marketing:member-coupon:query |
| PUT | /marketing/member-coupon/:id/freeze | 冻结优惠券 | marketing:member-coupon:freeze |

### 10.3 满减活动模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/full-reduction | 满减活动列表 | marketing:full-reduction:list |
| GET | /marketing/full-reduction/:id | 活动详情 | marketing:full-reduction:query |
| POST | /marketing/full-reduction | 创建活动 | marketing:full-reduction:add |
| PUT | /marketing/full-reduction/:id | 更新活动 | marketing:full-reduction:edit |
| DELETE | /marketing/full-reduction/:id | 删除活动 | marketing:full-reduction:remove |

### 10.4 促销活动模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/promotion | 促销活动列表 | marketing:promotion:list |
| GET | /marketing/promotion/:id | 活动详情 | marketing:promotion:query |
| POST | /marketing/promotion | 创建活动 | marketing:promotion:add |
| PUT | /marketing/promotion/:id | 更新活动 | marketing:promotion:edit |
| DELETE | /marketing/promotion/:id | 删除活动 | marketing:promotion:remove |
| GET | /marketing/promotion/:id/products | 活动商品列表 | marketing:promotion:product |
| POST | /marketing/promotion/:id/products | 添加活动商品 | marketing:promotion:product |
| DELETE | /marketing/promotion/:id/products/:productId | 移除活动商品 | marketing:promotion:product |

### 10.5 拼团管理模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/group-buy | 拼团订单列表 | marketing:group-buy:list |
| GET | /marketing/group-buy/:id | 拼团详情 | marketing:group-buy:query |
| GET | /marketing/group-buy/:id/members | 拼团成员 | marketing:group-buy:query |
| PUT | /marketing/group-buy/:id/close | 关闭拼团 | marketing:group-buy:close |

### 10.6 积分规则模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/point-rule | 积分规则列表 | marketing:point-rule:list |
| GET | /marketing/point-rule/:id | 规则详情 | marketing:point-rule:query |
| POST | /marketing/point-rule | 创建规则 | marketing:point-rule:add |
| PUT | /marketing/point-rule/:id | 更新规则 | marketing:point-rule:edit |
| DELETE | /marketing/point-rule/:id | 删除规则 | marketing:point-rule:remove |

### 10.7 积分商品模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/point-product | 积分商品列表 | marketing:point-product:list |
| GET | /marketing/point-product/:id | 商品详情 | marketing:point-product:query |
| POST | /marketing/point-product | 创建商品 | marketing:point-product:add |
| PUT | /marketing/point-product/:id | 更新商品 | marketing:point-product:edit |
| DELETE | /marketing/point-product/:id | 删除商品 | marketing:point-product:remove |

### 10.8 积分兑换模块

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /marketing/point-exchange | 兑换记录列表 | marketing:point-exchange:list |
| GET | /marketing/point-exchange/:id | 兑换详情 | marketing:point-exchange:query |
| PUT | /marketing/point-exchange/:id/ship | 发货 | marketing:point-exchange:ship |

---

## 十一、数据统计需求

### 11.1 优惠券统计

```
┌─────────────────────────────────────────────────────────────────┐
│                        优惠券数据看板                            │
├─────────────────┬─────────────────┬─────────────────────────────┤
│   已发放总量    │    已使用数量    │        使用率              │
│    12,580      │     8,420       │        66.9%              │
├─────────────────┴─────────────────┴─────────────────────────────┤
│                                                                  │
│  优惠券使用趋势图 (近30天)                                        │
│  ████████████████████████████████████████                       │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│  各类型优惠券使用占比                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                       │
│  │ 满减券   │  │ 折扣券   │  │ 无门槛券 │                       │
│  │  45%    │  │   35%   │  │   20%   │                       │
│  └──────────┘  └──────────┘  └──────────┘                       │
└──────────────────────────────────────────────────────────────────┘
```

### 11.2 促销活动统计

- 活动GMV（商品交易总额）
- 活动订单数
- 活动商品销量排行
- 活动转化率

### 11.3 积分统计

- 积分发放总量
- 积分消耗总量
- 积分过期总量
- 积分商品兑换排行

---

## 十二、扩展性考虑

### 12.1 后续可扩展功能

| 功能 | 说明 |
|------|------|
| 优惠券叠加规则 | 多张优惠券同时使用的规则配置 |
| 新人专享活动 | 仅新注册用户可参与的活动 |
| 会员专享价 | 不同会员等级享受不同价格 |
| 砍价活动 | 邀请好友帮砍价 |
| 抽奖活动 | 积分抽奖、大转盘等 |
| 分销返佣 | 推广返利机制 |

### 12.2 与其他系统集成点

```
┌─────────────────────────────────────────────────────────────────┐
│                        系统集成关系                              │
└─────────────────────────────────────────────────────────────────┘

     ┌─────────────┐
     │   订单系统   │
     └──────┬──────┘
            │
            ▼
  ┌─────────────────────────────────────────────────────────┐
  │                      营销系统                            │
  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐│
  │  │ 优惠券   │  │ 满减     │  │ 促销     │  │ 积分     ││
  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘│
  └──────────────────────┬──────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
  ┌──────────┐    ┌──────────┐    ┌──────────┐
  │  商品系统 │    │  会员系统 │    │  支付系统 │
  └──────────┘    └──────────┘    └──────────┘
        │                │                │
        ▼                ▼                ▼
  ┌──────────┐    ┌──────────┐    ┌──────────┐
  │商品价格   │    │会员等级   │    │退款处理   │
  │库存扣减   │    │积分余额   │    │优惠返还   │
  └──────────┘    └──────────┘    └──────────┘
```
