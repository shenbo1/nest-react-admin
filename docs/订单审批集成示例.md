# 订单审批集成示例

本文档演示如何将工作流系统与订单业务系统集成，实现订单审批的自动化流程。

## 一、业务场景

假设我们有一个采购订单系统，需要实现以下审批流程：

1. **订单创建** → 提交审批
2. **部门经理审批**（或直接主管）
3. **财务部门审批**（订单金额 > 10000元）
4. **总经理审批**（订单金额 > 50000元）
5. **审批完成** → 更新订单状态

## 二、流程设计

### 2.1 流程图结构

```
开始 → 部门经理审批 → 条件分支 → 财务审批 → 条件分支 → 总经理审批 → 结束
                     ↓              ↓
                   结束            结束
```

### 2.2 节点配置

| 节点 | 类型 | 审批人 | 条件 |
|------|------|--------|------|
| 部门经理审批 | 审批节点 | 发起人上级 | 无 |
| 财务审批 | 审批节点 | 财务角色 | 金额 > 10000 |
| 总经理审批 | 审批节点 | 指定人员 | 金额 > 50000 |

## 三、数据库设计

### 3.1 订单表

```sql
CREATE TABLE orders (
  id VARCHAR(32) PRIMARY KEY,
  order_no VARCHAR(32) NOT NULL UNIQUE,
  title VARCHAR(200) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  status VARCHAR(20) NOT NULL,
  applicant_id INT NOT NULL,
  applicant_name VARCHAR(50),
  dept_id INT,
  dept_name VARCHAR(100),
  supplier_name VARCHAR(200),
  items JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3.2 订单状态枚举

```typescript
enum OrderStatus {
  DRAFT = 'DRAFT',           // 草稿
  PENDING = 'PENDING',       // 待审批
  APPROVING = 'APPROVING',   // 审批中
  APPROVED = 'APPROVED',     // 已审批
  REJECTED = 'REJECTED',     // 已驳回
  CANCELLED = 'CANCELLED',   // 已取消
}
```

## 四、后端集成实现

### 4.1 订单服务集成

```typescript
// order.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '@/common/prisma/prisma.service';
import { CommandBus } from '@nestjs/cqrs';
import { StartFlowCommand } from '@/modules/workflow/commands/instance/start-flow.command';

@Injectable()
export class OrderService {
  constructor(
    private readonly prisma: PrismaService,
    private readonly commandBus: CommandBus,
  ) {}

  /**
   * 创建订单并启动审批流程
   */
  async createOrderAndStartApproval(data: CreateOrderDto, user: UserInfo) {
    // 1. 创建订单
    const order = await this.prisma.order.create({
      data: {
        id: this.generateOrderId(),
        orderNo: this.generateOrderNo(),
        title: data.title,
        amount: data.amount,
        status: OrderStatus.PENDING,
        applicantId: user.id,
        applicantName: user.name,
        deptId: user.deptId,
        deptName: user.deptName,
        supplierName: data.supplierName,
        items: data.items,
      },
    });

    // 2. 启动审批流程
    const flowInstance = await this.commandBus.execute(
      new StartFlowCommand({
        flowDefinitionId: 1, // 订单审批流程定义ID
        title: `采购订单审批: ${order.title}`,
        businessId: order.id,
        businessNo: order.orderNo,
        formData: {
          orderId: order.id,
          orderNo: order.orderNo,
          title: order.title,
          amount: order.amount,
          supplierName: order.supplierName,
          items: order.items,
        },
      }, {
        id: user.id,
        name: user.name,
        deptId: user.deptId,
        deptName: user.deptName,
      })
    );

    // 3. 更新订单关联的流程实例
    await this.prisma.order.update({
      where: { id: order.id },
      data: {
        status: OrderStatus.APPROVING,
        flowInstanceId: flowInstance.id,
      },
    });

    return { order, flowInstance };
  }

  /**
   * 更新订单状态
   */
  async updateOrderStatus(orderId: string, status: OrderStatus, extra?: any) {
    await this.prisma.order.update({
      where: { id: orderId },
      data: {
        status,
        ...extra,
        updatedAt: new Date(),
      },
    });
  }

  /**
   * 添加审批历史
   */
  async addApprovalHistory(orderId: string, history: any) {
    await this.prisma.orderApprovalHistory.create({
      data: {
        orderId,
        ...history,
      },
    });
  }
}
```

### 4.2 订单审批回调处理

```typescript
// order-approval.service.ts
import { Injectable, Logger } from '@nestjs/common';
import { CallbackPayload } from '@/modules/workflow/types/callback.types';
import { PrismaService } from '@/common/prisma/prisma.service';
import { OrderStatus } from '../entities/order.entity';

@Injectable()
export class OrderApprovalService {
  private readonly logger = new Logger(OrderApprovalService.name);

  constructor(private readonly prisma: PrismaService) {}

  /**
   * 处理订单审批回调
   */
  async handleOrderApprovalCallback(payload: CallbackPayload): Promise<void> {
    // 检查是否是订单流程
    if (!this.isOrderFlow(payload)) {
      return;
    }

    this.logger.log(`处理订单审批回调: ${payload.eventType}, 订单ID: ${payload.businessId}`);

    try {
      switch (payload.eventType) {
        case 'flow_started':
          await this.handleOrderApprovalStarted(payload);
          break;
        case 'flow_completed':
          await this.handleOrderApprovalCompleted(payload);
          break;
        case 'flow_rejected':
          await this.handleOrderApprovalRejected(payload);
          break;
        case 'task_approved':
          await this.handleOrderTaskApproved(payload);
          break;
      }
    } catch (error) {
      this.logger.error(`处理订单审批回调失败: ${error.message}`);
      throw error;
    }
  }

  /**
   * 处理订单审批开始
   */
  private async handleOrderApprovalStarted(payload: CallbackPayload): Promise<void> {
    await this.prisma.order.update({
      where: { id: payload.businessId },
      data: {
        status: OrderStatus.APPROVING,
        flowInstanceId: payload.flowInstanceId,
      },
    });
  }

  /**
   * 处理订单审批完成
   */
  private async handleOrderApprovalCompleted(payload: CallbackPayload): Promise<void> {
    await this.prisma.order.update({
      where: { id: payload.businessId },
      data: {
        status: OrderStatus.APPROVED,
        approvedAt: new Date(),
      },
    });

    // 触发后续业务逻辑
    await this.triggerPostApprovalActions(payload.businessId!);
  }

  /**
   * 处理订单审批被拒绝
   */
  private async handleOrderApprovalRejected(payload: CallbackPayload): Promise<void> {
    await this.prisma.order.update({
      where: { id: payload.businessId },
      data: {
        status: OrderStatus.REJECTED,
        rejectedAt: new Date(),
      },
    });
  }

  /**
   * 处理订单任务通过
   */
  private async handleOrderTaskApproved(payload: CallbackPayload): Promise<void> {
    if (!payload.task) return;

    await this.prisma.orderApprovalHistory.create({
      data: {
        orderId: payload.businessId!,
        nodeId: payload.task.nodeId,
        nodeName: payload.task.nodeName,
        approverId: payload.task.assigneeId,
        approverName: payload.task.assigneeName,
        result: 'APPROVED',
        comment: payload.task.comment,
        approvedAt: new Date(),
      },
    });
  }
}
```

### 4.3 流程定义配置

```json
{
  "code": "ORDER_APPROVAL",
  "name": "订单审批流程",
  "categoryId": 1,
  "flowData": {
    "nodes": [
      {
        "id": "start",
        "type": "START",
        "position": { "x": 100, "y": 100 },
        "data": { "label": "开始" }
      },
      {
        "id": "dept_manager",
        "type": "APPROVAL",
        "position": { "x": 300, "y": 100 },
        "data": { "label": "部门经理审批" }
      },
      {
        "id": "condition1",
        "type": "CONDITION",
        "position": { "x": 500, "y": 100 },
        "data": { "label": "金额判断" }
      },
      {
        "id": "finance",
        "type": "APPROVAL",
        "position": { "x": 700, "y": 50 },
        "data": { "label": "财务审批" }
      },
      {
        "id": "condition2",
        "type": "CONDITION",
        "position": { "x": 900, "y": 50 },
        "data": { "label": "金额判断" }
      },
      {
        "id": "ceo",
        "type": "APPROVAL",
        "position": { "x": 1100, "y": 0 },
        "data": { "label": "总经理审批" }
      },
      {
        "id": "end",
        "type": "END",
        "position": { "x": 1300, "y": 100 },
        "data": { "label": "结束" }
      }
    ],
    "edges": [
      {
        "id": "e1",
        "source": "start",
        "target": "dept_manager"
      },
      {
        "id": "e2",
        "source": "dept_manager",
        "target": "condition1"
      },
      {
        "id": "e3",
        "source": "condition1",
        "target": "finance",
        "data": { "condition": { "field": "amount", "operator": "gt", "value": 10000 } }
      },
      {
        "id": "e4",
        "source": "condition1",
        "target": "end",
        "data": { "condition": { "field": "amount", "operator": "lte", "value": 10000 } }
      },
      {
        "id": "e5",
        "source": "finance",
        "target": "condition2"
      },
      {
        "id": "e6",
        "source": "condition2",
        "target": "ceo",
        "data": { "condition": { "field": "amount", "operator": "gt", "value": 50000 } }
      },
      {
        "id": "e7",
        "source": "condition2",
        "target": "end",
        "data": { "condition": { "field": "amount", "operator": "lte", "value": 50000 } }
      },
      {
        "id": "e8",
        "source": "ceo",
        "target": "end"
      }
    ]
  },
  "nodeConfigs": [
    {
      "nodeId": "dept_manager",
      "nodeType": "APPROVAL",
      "nodeName": "部门经理审批",
      "approvalType": "OR_SIGN",
      "assigneeType": "INITIATOR_LEADER",
      "assigneeConfig": {},
      "emptyAssigneeAction": "TO_ADMIN",
      "timeLimit": 24,
      "timeoutAction": "REMIND"
    },
    {
      "nodeId": "finance",
      "nodeType": "APPROVAL",
      "nodeName": "财务审批",
      "approvalType": "OR_SIGN",
      "assigneeType": "ROLE",
      "assigneeConfig": {
        "roleIds": [3] // 财务审批角色
      },
      "emptyAssigneeAction": "TO_ADMIN",
      "timeLimit": 48,
      "timeoutAction": "AUTO_REJECT"
    },
    {
      "nodeId": "ceo",
      "nodeType": "APPROVAL",
      "nodeName": "总经理审批",
      "approvalType": "OR_SIGN",
      "assigneeType": "SPECIFIC_USER",
      "assigneeConfig": {
        "userIds": [1] // 总经理用户ID
      },
      "emptyAssigneeAction": "TO_ADMIN",
      "timeLimit": 72,
      "timeoutAction": "AUTO_REJECT"
    }
  ],
  "callbackConfig": [
    {
      "url": "http://localhost:3000/api/orders/callback",
      "method": "POST",
      "conditions": [
        {
          "type": "status",
          "operator": "in",
          "value": ["COMPLETED", "REJECTED", "CANCELLED"]
        }
      ],
      "bodyTemplate": "{\"eventType\": \"${eventType}\", \"orderId\": \"${businessId}\", \"status\": \"${status}\", \"instanceId\": ${flowInstanceId}}"
    }
  ]
}
```

## 五、前端集成

### 5.1 订单列表页面

```typescript
// OrderList.tsx
import React, { useState } from 'react';
import { Table, Button, Tag, Space, Modal } from 'antd';
import { useNavigate } from 'react-router-dom';
import { startFlow } from '@/services/workflow/instance';

const OrderList: React.FC = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);

  const columns = [
    {
      title: '订单编号',
      dataIndex: 'orderNo',
      key: 'orderNo',
    },
    {
      title: '订单标题',
      dataIndex: 'title',
      key: 'title',
    },
    {
      title: '金额',
      dataIndex: 'amount',
      key: 'amount',
      render: (amount: number) => `¥${amount.toFixed(2)}`,
    },
    {
      title: '状态',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => {
        const statusMap = {
          'DRAFT': { color: 'default', text: '草稿' },
          'PENDING': { color: 'warning', text: '待提交' },
          'APPROVING': { color: 'processing', text: '审批中' },
          'APPROVED': { color: 'success', text: '已审批' },
          'REJECTED': { color: 'error', text: '已驳回' },
          'CANCELLED': { color: 'default', text: '已取消' },
        };
        const { color, text } = statusMap[status] || { color: 'default', text: status };
        return <Tag color={color}>{text}</Tag>;
      },
    },
    {
      title: '操作',
      key: 'action',
      render: (_, record) => (
        <Space>
          <Button
            type="link"
            onClick={() => navigate(`/orders/${record.id}`)}
          >
            查看
          </Button>
          {record.status === 'PENDING' && (
            <Button
              type="primary"
              onClick={() => handleSubmitApproval(record)}
            >
              提交审批
            </Button>
          )}
          {record.status === 'APPROVING' && (
            <Button
              onClick={() => navigate(`/workflow/instance/${record.flowInstanceId}`)}
            >
              查看进度
            </Button>
          )}
        </Space>
      ),
    },
  ];

  const handleSubmitApproval = async (order: any) => {
    Modal.confirm({
      title: '提交审批',
      content: `确定要提交订单 ${order.orderNo} 进行审批吗？`,
      onOk: async () => {
        try {
          setLoading(true);
          const result = await startFlow({
            flowDefinitionId: 1, // 订单审批流程ID
            title: `采购订单审批: ${order.title}`,
            businessId: order.id,
            businessNo: order.orderNo,
            formData: {
              orderId: order.id,
              orderNo: order.orderNo,
              title: order.title,
              amount: order.amount,
              supplierName: order.supplierName,
              items: order.items,
            },
          });
          message.success('已提交审批');
          // 刷新列表
          loadData();
        } catch (error) {
          message.error('提交失败: ' + error.message);
        } finally {
          setLoading(false);
        }
      },
    });
  };

  return (
    <div>
      <Table
        columns={columns}
        dataSource={orders}
        loading={loading}
        rowKey="id"
      />
    </div>
  );
};

export default OrderList;
```

### 5.2 审批表单页面

```typescript
// OrderApprovalForm.tsx
import React, { useState, useEffect } from 'react';
import { Card, Form, Input, InputNumber, Table, Button, Space } from 'antd';
import { getTask } from '@/services/workflow/task';
import { approveTask, rejectTask } from '@/services/workflow/task';

const OrderApprovalForm: React.FC = ({ taskId, onSuccess }) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [task, setTask] = useState(null);

  useEffect(() => {
    loadTask();
  }, [taskId]);

  const loadTask = async () => {
    try {
      const taskData = await getTask(taskId);
      setTask(taskData);
      // 设置表单初始值
      form.setFieldsValue({
        ...taskData.formDataSnapshot,
        comment: '',
      });
    } catch (error) {
      message.error('加载任务失败');
    }
  };

  const handleApprove = async (values: any) => {
    try {
      setLoading(true);
      await approveTask(taskId, {
        comment: values.comment,
        formData: {
          ...values,
          comment: undefined,
        },
      });
      message.success('审批已通过');
      onSuccess();
    } catch (error) {
      message.error('审批失败: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleReject = async (values: any) => {
    Modal.confirm({
      title: '确认驳回',
      content: '确定要驳回该订单吗？',
      onOk: async () => {
        try {
          setLoading(true);
          await rejectTask(taskId, {
            comment: values.comment || '审批驳回',
          });
          message.success('已驳回');
          onSuccess();
        } catch (error) {
          message.error('操作失败: ' + error.message);
        } finally {
          setLoading(false);
        }
      },
    });
  };

  if (!task) return null;

  const orderData = task.formDataSnapshot;

  const columns = [
    {
      title: '商品名称',
      dataIndex: 'name',
      key: 'name',
    },
    {
      title: '规格',
      dataIndex: 'spec',
      key: 'spec',
    },
    {
      title: '数量',
      dataIndex: 'quantity',
      key: 'quantity',
    },
    {
      title: '单价',
      dataIndex: 'price',
      key: 'price',
      render: (price: number) => `¥${price.toFixed(2)}`,
    },
    {
      title: '小计',
      dataIndex: 'total',
      key: 'total',
      render: (total: number) => `¥${total.toFixed(2)}`,
    },
  ];

  return (
    <Form form={form} onFinish={handleApprove} layout="vertical">
      <Card title="订单信息" style={{ marginBottom: 16 }}>
        <Descriptions column={2}>
          <Descriptions.Item label="订单编号">
            {orderData.orderNo}
          </Descriptions.Item>
          <Descriptions.Item label="订单标题">
            {orderData.title}
          </Descriptions.Item>
          <Descriptions.Item label="供应商">
            {orderData.supplierName}
          </Descriptions.Item>
          <Descriptions.Item label="订单金额">
            <span style={{ color: '#ff4d4f', fontSize: 18, fontWeight: 'bold' }}>
              ¥{orderData.amount.toFixed(2)}
            </span>
          </Descriptions.Item>
        </Descriptions>

        <Table
          columns={columns}
          dataSource={orderData.items}
          pagination={false}
          rowKey="id"
        />
      </Card>

      <Card title="审批意见" style={{ marginBottom: 16 }}>
        <Form.Item
          name="comment"
          label="审批意见"
          rules={[{ required: true, message: '请输入审批意见' }]}
        >
          <Input.TextArea
            rows={4}
            placeholder="请输入您的审批意见..."
          />
        </Form.Item>
      </Card>

      <Form.Item>
        <Space>
          <Button type="primary" htmlType="submit" loading={loading}>
            通过
          </Button>
          <Button danger onClick={handleReject} loading={loading}>
            驳回
          </Button>
        </Space>
      </Form.Item>
    </Form>
  );
};

export default OrderApprovalForm;
```

## 六、测试验证

### 6.1 创建测试订单

```bash
curl -X POST http://localhost:3000/api/orders \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "title": "办公用品采购",
    "amount": 15000,
    "supplierName": "办公用品公司",
    "items": [
      {
        "name": "笔记本电脑",
        "spec": "ThinkPad X1",
        "quantity": 2,
        "price": 5000,
        "total": 10000
      },
      {
        "name": "显示器",
        "spec": "27寸 4K",
        "quantity": 2,
        "price": 2500,
        "total": 5000
      }
    ]
  }'
```

### 6.2 验证流程执行

1. **查看流程实例**：
   ```bash
   curl http://localhost:3000/api/workflow/instance/1
   ```

2. **查看待办任务**：
   ```bash
   curl http://localhost:3000/api/workflow/task/pending
   ```

3. **执行任务审批**：
   ```bash
   curl -X POST http://localhost:3000/api/workflow/task/1/approve \
     -H "Content-Type: application/json" \
     -d '{"comment": "同意采购"}'
   ```

4. **查看流程进度**：
   ```bash
   curl http://localhost:3000/api/workflow/instance/1/progress
   ```

### 6.3 验证业务回调

查看订单状态是否随流程状态更新：

```bash
curl http://localhost:3000/api/orders/ORD202512260001
```

## 七、总结

通过本示例，我们展示了如何：

1. **设计审批流程**：根据业务需求设计节点和条件
2. **配置流程定义**：设置审批人、条件、回调等
3. **业务系统集成**：在业务代码中调用工作流API
4. **处理回调事件**：根据流程状态更新业务数据
5. **前端页面集成**：提供用户友好的审批界面

这套方案可以灵活应用于各种业务场景，如：
- 采购订单审批
- 费用报销审批
- 合同审批
- 人事审批（请假、入职、离职）
- 项目立项审批

只需根据具体业务需求调整流程设计和回调处理即可。