# 数据脱敏功能文档

## 概述

本系统实现了基于装饰器和拦截器的数据脱敏功能，支持根据用户权限控制是否脱敏。对于没有相应权限的用户，敏感数据会自动进行脱敏处理后返回。

## 脱敏规则

| 类型 | 脱敏效果 | 权限标识 |
|------|---------|---------|
| 手机号 | `138****1234` | `data:sensitive:phone` |
| 邮箱 | `t***@example.com` | `data:sensitive:email` |
| 身份证 | `110***********1234` | `data:sensitive:idcard` |
| 银行卡/税号 | `6222****1234` | `data:sensitive:bankcard` |
| 姓名 | `张*` 或 `张*三` | `data:sensitive:name` |
| 地址 | `北京市朝阳区****` | `data:sensitive:address` |

**特殊权限：**
- `data:sensitive:all` - 可查看所有敏感数据
- `admin` 角色 - 自动跳过脱敏处理

## 涉及的敏感字段

| 模块 | 字段 | 脱敏类型 |
|------|------|---------|
| Member（会员） | phone | 手机号 |
| Member（会员） | email | 邮箱 |
| MemberAddress（收货地址） | phone | 手机号 |
| MemberAddress（收货地址） | receiver | 姓名 |
| MemberInvoice（发票信息） | invoicePhone | 手机号 |
| MemberInvoice（发票信息） | invoiceEmail | 邮箱 |
| MemberInvoice（发票信息） | invoiceTaxNo | 银行卡/税号 |
| MemberInvoice（发票信息） | bankAccount | 银行卡/税号 |

## 技术实现

### 核心文件

```
apps/admin-api/src/common/
├── constants/
│   └── sensitive.constant.ts    # 脱敏类型枚举和权限映射
├── utils/
│   └── mask.util.ts             # 脱敏工具函数
├── decorators/
│   └── sensitive.decorator.ts   # @Sensitive 装饰器
└── interceptors/
    └── sensitive.interceptor.ts # 脱敏拦截器
```

### 1. 脱敏类型枚举

```typescript
// sensitive.constant.ts
export enum SensitiveType {
  PHONE = 'PHONE',
  EMAIL = 'EMAIL',
  ID_CARD = 'ID_CARD',
  BANK_CARD = 'BANK_CARD',
  NAME = 'NAME',
  ADDRESS = 'ADDRESS',
}
```

### 2. 脱敏工具函数

```typescript
// mask.util.ts
import { MaskUtil } from '@/common/utils/mask.util';

// 手机号脱敏
MaskUtil.maskPhone('13812345678');  // 138****5678

// 邮箱脱敏
MaskUtil.maskEmail('test@example.com');  // t***@example.com

// 身份证脱敏
MaskUtil.maskIdCard('110101199001011234');  // 110***********1234

// 银行卡脱敏
MaskUtil.maskBankCard('6222021234567890');  // 6222****7890

// 姓名脱敏
MaskUtil.maskName('张三');  // 张*
MaskUtil.maskName('张三丰');  // 张*丰
```

### 3. @Sensitive 装饰器（可选使用）

如果需要创建自定义 VO 类，可以使用装饰器标记敏感字段：

```typescript
import { Sensitive } from '@/common/decorators';
import { SensitiveType } from '@/common/constants/sensitive.constant';

export class MemberVo {
  id: number;
  username: string;

  @Sensitive(SensitiveType.PHONE)
  phone: string;

  @Sensitive(SensitiveType.EMAIL)
  email: string;
}
```

### 4. 拦截器自动脱敏

拦截器通过预定义的字段配置自动识别敏感字段，无需修改现有 Service 代码：

```typescript
// 拦截器内置配置
const SENSITIVE_FIELD_CONFIG = {
  member: [
    { field: 'phone', type: SensitiveType.PHONE },
    { field: 'email', type: SensitiveType.EMAIL },
  ],
  memberAddress: [
    { field: 'phone', type: SensitiveType.PHONE },
    { field: 'receiver', type: SensitiveType.NAME },
  ],
  memberInvoiceInfo: [
    { field: 'invoiceTaxNo', type: SensitiveType.BANK_CARD },
    { field: 'invoiceEmail', type: SensitiveType.EMAIL },
    { field: 'invoicePhone', type: SensitiveType.PHONE },
    { field: 'bankAccount', type: SensitiveType.BANK_CARD },
  ],
};
```

## 使用方式

### 零侵入模式（推荐）

直接使用 Prisma 返回的数据，拦截器会自动进行脱敏处理：

```typescript
// member.service.ts
async findAll(query: QueryMemberDto) {
  const [data, total] = await Promise.all([
    this.prisma.member.findMany({ ... }),
    this.prisma.member.count({ where }),
  ]);
  return { data, total, page, pageSize };
  // 返回的 data 中的 phone/email 会自动脱敏
}
```

### 权限配置

在角色管理中为用户分配相应的敏感数据查看权限：

- **查看所有敏感数据** (`data:sensitive:all`) - 拥有此权限可查看所有完整敏感信息
- **查看完整手机号** (`data:sensitive:phone`)
- **查看完整邮箱** (`data:sensitive:email`)
- **查看完整身份证** (`data:sensitive:idcard`)
- **查看完整银行卡号** (`data:sensitive:bankcard`)
- **查看完整姓名** (`data:sensitive:name`)
- **查看完整地址** (`data:sensitive:address`)

## 扩展指南

### 添加新的敏感字段

1. **更新拦截器配置**

在 `sensitive.interceptor.ts` 的 `SENSITIVE_FIELD_CONFIG` 中添加新的字段配置：

```typescript
const SENSITIVE_FIELD_CONFIG = {
  // ... 现有配置
  newModel: [
    { field: 'sensitiveField', type: SensitiveType.PHONE },
  ],
};
```

2. **更新字段检测逻辑**

在 `getSensitiveFieldsFromConfig` 方法中添加新模型的检测逻辑：

```typescript
// 检测 NewModel
if ('uniqueField' in obj) {
  const config = SENSITIVE_FIELD_CONFIG.newModel;
  // ...
}
```

### 添加新的脱敏类型

1. 在 `sensitive.constant.ts` 中添加新的枚举值和权限映射
2. 在 `mask.util.ts` 中实现对应的脱敏方法
3. 在 `seed.ts` 中添加对应的权限菜单
4. 在前端 `permissions.ts` 中添加权限常量

## 数据流程

```
请求 → JwtGuard → Controller → Service → Prisma 返回数据
                                              ↓
                                    SensitiveInterceptor
                                    ├─ 获取用户权限 (ClsService)
                                    ├─ 判断是否需要脱敏
                                    ├─ 递归遍历响应数据
                                    ├─ 匹配敏感字段
                                    └─ 执行脱敏处理
                                              ↓
                                    TransformInterceptor (响应包装)
                                              ↓
                                          返回前端
```

## 注意事项

1. **拦截器执行顺序**：`SensitiveInterceptor` 在 `TransformInterceptor` 之前执行
2. **超级管理员**：`admin` 角色自动跳过脱敏处理
3. **空值处理**：`null` 或 `undefined` 字段不进行脱敏
4. **嵌套对象**：支持嵌套对象的递归脱敏
5. **性能考虑**：拦截器使用对象特征检测，避免反射开销

## 相关文件

| 文件 | 说明 |
|------|------|
| `apps/admin-api/src/common/constants/sensitive.constant.ts` | 脱敏常量定义 |
| `apps/admin-api/src/common/utils/mask.util.ts` | 脱敏工具函数 |
| `apps/admin-api/src/common/decorators/sensitive.decorator.ts` | @Sensitive 装饰器 |
| `apps/admin-api/src/common/interceptors/sensitive.interceptor.ts` | 脱敏拦截器 |
| `apps/admin-api/src/app.module.ts` | 全局拦截器注册 |
| `apps/admin-api/prisma/seed.ts` | 权限菜单种子数据 |
| `apps/admin-web/src/constants/permissions.ts` | 前端权限常量 |
