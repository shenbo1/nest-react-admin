# 普通列表开发规范

## 概述

本文档定义了项目中普通列表（非树形结构）的标准开发规范，基于用户管理页面的最佳实践。

## 标准结构

### 1. 文件结构
```
src/pages/{module}/
├── index.tsx          # 列表主页面
├── components/        # 页面专用组件（可选）
└── types.ts          # 类型定义（可选）
```

### 2. 页面模板

```typescript
import { useRef, useState } from 'react';
import { PlusOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons';
import { ProColumns, ModalForm, ProFormText, ProFormSelect } from '@ant-design/pro-components';
import { message, Popconfirm, Space } from 'antd';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import { moduleApi, ModuleType, CreateModuleDto } from '@/services/module/module';
import PermissionButton from '@/components/PermissionButton';
import ProTable, { ProTableRef } from '@/components/ProTable';
import { SYSTEM } from '@/constants/permissions';
import dayjs from 'dayjs';

const ModuleList: React.FC = () => {
  const tableRef = useRef<ProTableRef>(null);
  const [modalOpen, setModalOpen] = useState(false);
  const [editingId, setEditingId] = useState<number | null>(null);
  const [editingRecord, setEditingRecord] = useState<ModuleType | null>(null);
  const queryClient = useQueryClient();

  // 查询相关数据（下拉选项等）
  const { data: options } = useQuery({
    queryKey: ['module-options'],
    queryFn: moduleApi.getOptions,
  });

  // 创建/更新
  const saveMutation = useMutation({
    mutationFn: (values: CreateModuleDto) => {
      if (editingId) {
        return moduleApi.update(editingId, values);
      }
      return moduleApi.create(values);
    },
    onSuccess: () => {
      message.success(editingId ? '更新成功' : '创建成功');
      setModalOpen(false);
      setEditingId(null);
      setEditingRecord(null);
      tableRef.current?.reload();
      queryClient.invalidateQueries({ queryKey: ['modules'] });
    },
  });

  // 删除
  const deleteMutation = useMutation({
    mutationFn: moduleApi.delete,
    onSuccess: () => {
      message.success('删除成功');
      tableRef.current?.reload();
    },
  });

  // 状态切换（如需要）
  const toggleStatusMutation = useMutation({
    mutationFn: moduleApi.toggleStatus,
    onSuccess: () => {
      message.success('状态修改成功');
      tableRef.current?.reload();
    },
  });

  const handleEdit = (record: ModuleType) => {
    setEditingId(record.id);
    setEditingRecord(record);
    setModalOpen(true);
  };

  const handleAdd = () => {
    setEditingId(null);
    setEditingRecord(null);
    setModalOpen(true);
  };

  const columns: ProColumns<ModuleType>[] = [
    // 基础字段列
    {
      title: '名称',
      dataIndex: 'name',
      width: 120,
    },
    {
      title: '状态',
      dataIndex: 'status',
      width: 100,
      valueType: 'select',
      valueEnum: {
        ENABLED: { text: '启用', status: 'Success' },
        DISABLED: { text: '停用', status: 'Error' },
      },
      hideInSearch: true,
    },
    {
      title: '创建时间',
      dataIndex: 'createdAt',
      width: 160,
      valueType: 'dateTime',
      hideInSearch: true,
      render: (_, record) => dayjs(record.createdAt).format('YYYY-MM-DD HH:mm'),
    },
    // 操作列
    {
      title: '操作',
      valueType: 'option',
      width: 200,
      fixed: 'right',
      render: (_, record) => (
        <Space size={0} split={<span style={{ color: '#d9d9d9' }}>|</span>}>
          <PermissionButton
            type="link"
            size="small"
            permission={SYSTEM.MODULE.EDIT}
            icon={<EditOutlined />}
            onClick={() => handleEdit(record)}
            fallbackMode="disabled"
          >
            编辑
          </PermissionButton>
          <Popconfirm title="确定删除吗？" onConfirm={() => deleteMutation.mutate(record.id)}>
            <PermissionButton
              type="link"
              size="small"
              danger
              permission={SYSTEM.MODULE.REMOVE}
              icon={<DeleteOutlined />}
              fallbackMode="disabled"
            >
              删除
            </PermissionButton>
          </Popconfirm>
        </Space>
      ),
    },
  ];

  const fetchData = async (params: any) => {
    const { current, pageSize, ...rest } = params;
    const result = await moduleApi.list({
      page: current,
      pageSize,
      ...rest,
    });
    return {
      data: result.data,
      total: result.total,
      success: true,
    };
  };

  return (
    <>
      <ProTable
        ref={tableRef}
        columns={columns}
        rowKey="id"
        scroll={{ x: 1000 }}  // 根据列宽调整
        request={fetchData}
        search={{
          labelWidth: 'auto',
        }}
        pagination={{
          showSizeChanger: true,
          showTotal: (total: number) => `共 ${total} 条`,
        }}
        toolBarRender={() => [
          <PermissionButton
            key="add"
            permission={SYSTEM.MODULE.ADD}
            type="primary"
            icon={<PlusOutlined />}
            onClick={handleAdd}
          >
            新增
          </PermissionButton>,
        ]}
      />

      {/* 新增/编辑弹窗 */}
      <ModalForm
        title={editingId ? '编辑' : '新增'}
        open={modalOpen}
        onOpenChange={setModalOpen}
        width={600}
        initialValues={editingRecord || { status: 'ENABLED' }}
        modalProps={{
          destroyOnHidden: true,
        }}
        onFinish={async (values) => {
          await saveMutation.mutateAsync(values);
          return true;
        }}
      >
        {/* 表单字段 */}
        <ProFormText
          name="name"
          label="名称"
          rules={[{ required: true, message: '请输入名称' }]}
          placeholder="请输入名称"
        />
        <ProFormSelect
          name="status"
          label="状态"
          options={[
            { label: '启用', value: 'ENABLED' },
            { label: '停用', value: 'DISABLED' },
          ]}
        />
      </ModalForm>
    </>
  );
};

export default ModuleList;
```

## 核心规则

### 1. 状态管理
- 使用 `useRef<ProTableRef>(null)` 获取表格实例
- 使用 `useState` 管理弹窗状态和编辑数据
- 使用 `useQueryClient` 管理数据缓存

### 2. 数据操作
- **查询**：使用 `useQuery` 获取下拉选项等静态数据
- **新增/更新**：使用单个 `useMutation` 处理，通过 `editingId` 区分
- **删除**：独立 `useMutation`，成功后刷新表格
- **状态切换**：独立 `useMutation`，带确认提示

### 3. 表格配置
- **rowKey**：始终使用唯一标识字段（如 `id`）
- **scroll**：根据列宽设置横向滚动（建议 1000-1400）
- **pagination**：启用 `showSizeChanger` 和 `showTotal`
- **search**：使用 `labelWidth: 'auto'` 自动调整标签宽度

### 4. 列配置规则
- **基础字段**：名称、状态、时间等
- **搜索控制**：
  - `hideInSearch: true` - 不显示在搜索栏
  - `valueType: 'select'` - 下拉搜索
- **宽度设置**：
  - 名称类：120-150
  - 时间类：160-180
  - 状态类：80-100
  - 操作列：180-240，固定右侧

### 5. 操作按钮规范
- **新增按钮**：位于工具栏，使用 `PermissionButton`
- **行内操作**：使用 `Space` 组件，分隔符为 `|`
- **权限控制**：所有按钮使用 `PermissionButton` 包裹
- **删除确认**：使用 `Popconfirm` 组件
- **图标使用**：
  - 新增：`<PlusOutlined />`
  - 编辑：`<EditOutlined />`
  - 删除：`<DeleteOutlined />`

### 6. 弹窗规范
- **标题**：新增/编辑动态显示
- **宽度**：建议 600（根据表单复杂度调整）
- **销毁**：设置 `destroyOnHidden: true`
- **初始值**：编辑时传入记录数据，新增时设置默认值
- **提交**：返回 `true` 关闭弹窗，`false` 保持打开

### 7. 消息提示
- **成功消息**：使用 `message.success`
- **错误处理**：在 `onError` 中统一处理
- **确认提示**：删除、状态变更等操作需要确认

### 8. 权限常量
- 统一从 `@/constants/permissions` 导入
- 格式：`SYSTEM.{MODULE}.{ACTION}`
- 常用动作：ADD、EDIT、REMOVE、LIST、QUERY

### 9. 服务接口
- 统一放在 `@/services/{module}/{module}.ts`
- 标准方法：list、create、update、delete、detail
- 返回格式统一处理分页和错误

### 10. 数据缓存
- 查询键使用数组格式：`['modules']`
- 操作成功后失效相关缓存：`queryClient.invalidateQueries`
- 下拉数据可单独缓存：`['module-options']`

## 可选功能

### 批量操作
```typescript
const [selectedRowKeys, setSelectedRowKeys] = useState<number[]>([]);

rowSelection={{
  selectedRowKeys,
  onChange: setSelectedRowKeys,
}}
```

### 导出功能
```typescript
toolBarRender={() => [
  <Button key="export" onClick={handleExport}>导出</Button>,
  <PermissionButton key="add" permission={SYSTEM.MODULE.ADD}>新增</PermissionButton>,
]}
```

### 高级搜索
```typescript
search={{
  labelWidth: 'auto',
  optionRender: (searchConfig, formProps, dom) => [
    ...dom,
    <Button key="reset" onClick={() => handleReset()}>重置</Button>,
  ],
}}
```

## 性能优化

1. **数据缓存**：合理使用 React Query 缓存
2. **分页加载**：后端必须支持分页
3. **列宽优化**：避免过宽列导致横向滚动
4. **懒加载**：弹窗使用 `destroyOnHidden` 释放内存
5. **防抖搜索**：搜索输入建议加防抖

## 错误处理

1. **网络错误**：统一在 request 拦截器中处理
2. **业务错误**：在 mutation 的 `onError` 中处理
3. **表单验证**：使用 ProForm 的 rules 属性
4. **操作确认**：危险操作必须有确认步骤

## 样式规范

1. **按钮样式**：
   - 新增：primary 类型
   - 编辑：link 类型
   - 删除：link + danger 类型
2. **间距规范**：
   - 操作按钮间距：size="small"
   - 操作分隔符：灰色竖线
3. **对齐方式**：
   - 文本左对齐
   - 数字右对齐
   - 状态居中
   - 操作居中